<!doctype html>   
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />

  <title>Tours en Valdivia: fluviales, terrestres y alojamientos | Vacaciones en el Sur</title>

  <!-- ‚úÖ DESCRIPCI√ìN SEO -->
  <meta name="description" content="Tours fluviales y terrestres en Valdivia + alojamientos en la Regi√≥n de Los R√≠os. Reserva por formulario y te contactamos por WhatsApp para coordinar horarios y pagos." />

  <!-- ‚úÖ CANONICAL (c√°mbialo si tu dominio final es otro) -->
  <link rel="canonical" href="https://www.vacacionesenelsurdechile.cl/" />

  <!-- ‚úÖ ROBOTS -->
  <meta name="robots" content="index,follow,max-image-preview:large" />

  <!-- ‚úÖ OPEN GRAPH -->
  <meta property="og:locale" content="es_CL" />
  <meta property="og:type" content="website" />
  <meta property="og:site_name" content="Vacaciones en el Sur" />
  <meta property="og:title" content="Tours en Valdivia: fluviales, terrestres y alojamientos | Vacaciones en el Sur" />
  <meta property="og:description" content="Tours fluviales y terrestres en Valdivia + alojamientos en la Regi√≥n de Los R√≠os. Reserva por formulario y te contactamos por WhatsApp." />
  <meta property="og:url" content="https://vacacionesenelsur.cl/" />
  <meta property="og:image" content="https://vacacionesenelsur.cl/Fotos/Valdivia-citytour2.jpg" />

  <!-- ‚úÖ TWITTER -->
  <meta name="twitter:card" content="summary_large_image" />
  <meta name="twitter:title" content="Tours en Valdivia: fluviales, terrestres y alojamientos | Vacaciones en el Sur" />
  <meta name="twitter:description" content="Tours fluviales y terrestres en Valdivia + alojamientos en la Regi√≥n de Los R√≠os. Te contactamos por WhatsApp." />
  <meta name="twitter:image" content="https://vacacionesenelsur.cl/Fotos/Valdivia-citytour2.jpg" />

  <!-- ‚úÖ META PIXEL (VA EN HEAD) -->
  <script>
  !function(f,b,e,v,n,t,s)
  {if(f.fbq)return;n=f.fbq=function(){n.callMethod?
  n.callMethod.apply(n,arguments):n.queue.push(arguments)};
  if(!f._fbq)f._fbq=n;n.push=n;n.loaded=!0;n.version='2.0';
  n.queue=[];t=b.createElement(e);t.async=!0;
  t.src=v;s=b.getElementsByTagName(e)[0];
  s.parentNode.insertBefore(t,s)}(window, document,'script',
  'https://connect.facebook.net/en_US/fbevents.js');
  fbq('init', '2988189631474288');
  fbq('track', 'PageView');
  </script>
  <!-- ‚úÖ FIN META PIXEL -->

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600;700&family=Poppins:wght@300;400;500;600&family=Satisfy&display=swap" rel="stylesheet">

  <style>
    :root{
      --heroH: clamp(620px, 72vh, 780px);

      /* ‚úÖ NUEVA PALETA AZUL CLARO (3 tonos) */
      --sun1:#5aa9ff;
      --sun2:#2f7dff;
      --sun3:#0f58d6;
      --sun4:#a6d4ff;

      /* ‚úÖ FONDO 1 SOLO COLOR */
      --bg1:#eaf5ff;
      --bg2:#eaf5ff;
      --bg3:#eaf5ff;

      --ink:#14131a;
      --muted:#5a5564;

      --card: rgba(255,255,255,.84);
      --border: rgba(20,19,26,.10);
      --shadow: 0 16px 50px rgba(20,19,26,.10);
      --shadow2: 0 10px 24px rgba(20,19,26,.10);
      --radius: 18px;

      /* üëá Control √∫nico del tama√±o de TODAS las fotos de cards */
      --cardMediaH: 170px;
    }

    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; overflow-x:hidden; }
    body{
      margin:0;
      font-family:Poppins, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      color:var(--ink);
      background: var(--bg1);
      overflow-x:hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    body::before, body::after{
      content:"";
      position:fixed;
      inset:-28%;
      z-index:-1;
      opacity:.42;
      filter: blur(54px);
      pointer-events:none;
      animation: floaty 16s ease-in-out infinite;
      background:
        radial-gradient(460px 340px at 16% 18%, rgba(90,169,255,.28), transparent 62%),
        radial-gradient(620px 420px at 82% 22%, rgba(47,125,255,.20), transparent 64%),
        radial-gradient(560px 460px at 56% 88%, rgba(15,88,214,.14), transparent 64%),
        radial-gradient(560px 380px at 28% 78%, rgba(166,212,255,.22), transparent 64%);
    }
    body::after{ opacity:.26; animation-duration: 20s; animation-direction: reverse; }
    @keyframes floaty{
      0%{ transform: translate3d(0,0,0) scale(1); }
      50%{ transform: translate3d(3%, -2%, 0) scale(1.03); }
      100%{ transform: translate3d(0,0,0) scale(1); }
    }

    a{ color:inherit; text-decoration:none; }
    img, svg, video{ max-width:100%; height:auto; display:block; }

    .container{ width:min(1160px, 92vw); margin:0 auto; }

    header{
      position:sticky; top:0; z-index:40;
      background: rgba(255,255,255,.78);
      backdrop-filter: blur(10px);
      border-bottom:1px solid rgba(20,19,26,.08);
    }
    .nav{
      display:flex; align-items:center; justify-content:space-between;
      gap:12px; padding:12px 0;
    }
    .brand{ display:flex; align-items:center; gap:12px; min-width: 240px; }

    /* ‚úÖ NUEVO LOGO: usa imagen de perfil */
    /* LOGO (badge) */
    .logo{
      width: 54px;
      height: 54px;
      border-radius: 50%;
      overflow: hidden;
      background: #fff;
      border: 1px solid rgba(0,0,0,.08);
      box-shadow: 0 10px 30px rgba(0,0,0,.12);
      flex: 0 0 auto;
    }

    .logo img{
      width: 100%;
      height: 100%;
      display: block;
      object-fit: cover;          /* recorta sin deformar */
      object-position: center;    /* centra el contenido */
      transform: scale(1.18);     /* ‚Äúzoom‚Äù para comerse bordes blancos */
    }

    .brand h1{
      margin:0; font-size:13px; letter-spacing:.12em;
      text-transform:uppercase; font-weight:700; line-height:1.2;
    }
    .brand small{ display:block; margin-top:2px; font-size:12px; color:var(--muted); line-height:1.2; }

    nav ul{
      display:flex; gap:10px; list-style:none;
      padding:0; margin:0;
      flex-wrap:wrap; justify-content:flex-end; align-items:center;
    }
    nav a{
      font-size:13px; color:#2b2832;
      padding:8px 10px; border-radius:999px;
      transition: background .15s ease, transform .15s ease;
      white-space:nowrap;
    }
    nav a:hover{ background: rgba(47,125,255,.12); transform: translateY(-1px); }

    .menu-btn{
      display:none;
      border:1px solid rgba(20,19,26,.10);
      background: rgba(255,255,255,.80);
      border-radius:14px;
      width:44px; height:44px;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(20,19,26,.08);
      user-select:none;
      line-height:1; font-size:20px;
    }
    .menu-btn:active{ transform: translateY(1px); }

    @media (max-width: 820px){
      nav{ display:none; }
      .menu-btn{ display:inline-grid; place-items:center; }
      .brand{ min-width:auto; }
      .nav{ padding:10px 0; }
    }

    .drawer-backdrop{
      position:fixed; inset:0;
      background: rgba(20,19,26,.22);
      backdrop-filter: blur(6px);
      display:none; z-index:70;
      padding:16px;
      overscroll-behavior: contain;
    }
    .drawer{
      width:min(420px, 94vw);
      margin-left:auto;
      background: rgba(255,255,255,.94);
      border:1px solid rgba(20,19,26,.10);
      border-radius:22px;
      box-shadow: 0 24px 70px rgba(20,19,26,.18);
      overflow:hidden;
    }
    .drawer-head{
      padding:14px 16px;
      display:flex; justify-content:space-between; align-items:center;
      background: linear-gradient(135deg, rgba(166,212,255,.30), rgba(90,169,255,.16), rgba(47,125,255,.10));
      border-bottom:1px solid rgba(20,19,26,.08);
    }
    .drawer-head b{
      letter-spacing:.16em; text-transform:uppercase; font-size:12px; color:#2b2832;
    }
    .drawer-close{
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid rgba(20,19,26,.10);
      background: rgba(255,255,255,.78);
      cursor:pointer;
      font-size:18px;
    }
    .drawer-body{
      padding:14px 16px 16px;
      display:flex; flex-direction:column; gap:10px;
    }
    .drawer-link{
      padding:12px 12px;
      border-radius:16px;
      border:1px solid rgba(20,19,26,.10);
      background: rgba(255,255,255,.88);
      font-weight:700;
      color:#2b2832;
    }
    .drawer-link:active{ transform: translateY(1px); }
    .drawer-note{ margin-top:6px; font-size:12.5px; color:var(--muted); line-height:1.45; }

    .hero{ padding:34px 0 18px; }
    .hero-box{
      border-radius: 26px;
      background: rgba(255,255,255,.76);
      border:1px solid rgba(20,19,26,.08);
      box-shadow: var(--shadow);
      padding:18px;
      overflow:hidden;
      position:relative;
    }
    .hero-box::before{
      content:"";
      position:absolute; inset:-2px;
      z-index:0;
      opacity:.36;
      background:
        radial-gradient(520px 340px at 12% 16%, rgba(90,169,255,.26), transparent 62%),
        radial-gradient(640px 420px at 92% 22%, rgba(47,125,255,.18), transparent 64%),
        radial-gradient(520px 420px at 58% 120%, rgba(15,88,214,.12), transparent 66%);
      filter: blur(48px);
      pointer-events:none;
    }
    .hero-content{ position:relative; z-index:1; }
    .hero-grid{
      display:grid;
      grid-template-columns: minmax(0,1fr) minmax(0,1fr);
      gap:16px;
      align-items:stretch;
      grid-template-areas: "media side";
    }
    .hero-media{ grid-area: media; height: var(--heroH); }
    .hero-side{ grid-area: side; height: var(--heroH); min-width:0; }

    @media (max-width: 980px){
      .hero-grid{ grid-template-columns: 1fr; grid-template-areas: "side" "media"; }
      .hero-media, .hero-side{ height:auto; }
    }

    .kicker{
      display:inline-flex; align-items:center; gap:10px;
      font-size:12px; letter-spacing:.22em;
      text-transform:uppercase;
      color:#3c3646;
      margin:0 0 10px;
    }
    .dot{
      width:10px; height:10px; border-radius:999px;
      background: linear-gradient(135deg, var(--sun4), var(--sun1), var(--sun2));
      box-shadow: 0 0 0 6px rgba(47,125,255,.10);
    }
    .hero-title{
      margin:0;
      font-family:"Playfair Display", serif;
      font-size:44px; line-height:1.06;
      letter-spacing:.01em;
    }
    .script{
      font-family:"Satisfy", cursive;
      font-weight:400;
      background: linear-gradient(90deg, var(--sun1), var(--sun2), var(--sun4));
      -webkit-background-clip:text; background-clip:text;
      color:transparent;
      white-space:nowrap;
    }
    .hero-sub{
      margin:12px 0 0;
      color:#3c3646;
      font-size:15px;
      line-height:1.6;
    }
    .hero-sub b{ color:#221f29; }

    .video-card{
      height:100%;
      border-radius:22px;
      background: rgba(255,255,255,.84);
      border:1px solid rgba(20,19,26,.10);
      box-shadow: var(--shadow2);
      padding:12px;
      display:flex; flex-direction:column; gap:10px;
      overflow:hidden;
      min-width:0;
    }
    .video-wrap{
      position:relative;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(20,19,26,.10);
      background: linear-gradient(135deg, rgba(90,169,255,.12), rgba(47,125,255,.08), rgba(15,88,214,.06));
      flex:1; min-height:0;
    }
    .video-wrap video{ width:100%; height:100%; object-fit: cover; background:#111; }
    .video-play{
      position:absolute; left:12px; bottom:12px;
      border:0; border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800; font-size:13px;
      color:#fff;
      background: linear-gradient(135deg, var(--sun1), var(--sun2));
      box-shadow: 0 18px 40px rgba(20,19,26,.22);
    }
    .video-sound{
      position:absolute; right:12px; bottom:12px;
      border:1px solid rgba(255,255,255,.26);
      border-radius:999px;
      padding:10px 12px;
      cursor:pointer;
      font-weight:800; font-size:13px;
      color:#fff;
      background: rgba(20,19,26,.42);
      backdrop-filter: blur(8px);
      display:none;
    }
    .video-hint{ font-size:12.5px; color:var(--muted); line-height:1.45; margin:0; }
    .video-hint b{ color:#221f29; }

    @media (max-width: 980px){
      .hero-title{ font-size:34px; }
      .video-wrap{ aspect-ratio: 9 / 16; flex:0 0 auto; }
    }
    @media (max-width: 640px){
      .hero-title{ font-size:30px; }
      .hero-box{ padding:14px; }
      :root{ --cardMediaH: 180px; }
    }

    .side-card{
      height:100%;
      display:flex; flex-direction:column;
      min-width:0;
      background: rgba(255,255,255,.84);
      border: 1px solid rgba(20,19,26,.10);
      border-radius: 22px;
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .side-top{
      padding:14px 16px 12px;
      border-bottom: 1px solid rgba(20,19,26,.08);
    }
    .side-scroll{
      padding:14px 16px 16px;
      overflow:auto;
      min-height:0; flex:1;
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }
    .side-scroll::-webkit-scrollbar{ width:10px; }
    .side-scroll::-webkit-scrollbar-thumb{
      background: rgba(20,19,26,.14);
      border-radius:999px;
      border:3px solid rgba(255,255,255,.75);
    }

    .btn{
      border:0;
      border-radius: 14px;
      padding:10px 14px;
      font-weight:800;
      font-size:13px;
      cursor:pointer;
      display:inline-flex;
      gap:10px;
      align-items:center;
      justify-content:center;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
      white-space:nowrap;
      line-height:1.1;
      transform: translateZ(0);
    }
    .btn:active{ transform: translateY(1px) translateZ(0); }
    .btn-primary{
      color:#fff;
      background: linear-gradient(135deg, var(--sun1), var(--sun2));
      border:1px solid rgba(20,19,26,.10);
      box-shadow: 0 16px 34px rgba(47,125,255,.22);
    }
    .btn-ghost{
      color:#2b2832;
      background: rgba(255,255,255,.80);
      border:1px solid rgba(20,19,26,.10);
      box-shadow: 0 10px 20px rgba(20,19,26,.06);
    }
    .btn-ghost:hover{ background: rgba(47,125,255,.10); }

    section{ padding:30px 0; }
    [id]{ scroll-margin-top: 88px; }

    .section-head{
      display:flex; justify-content:space-between; align-items:flex-end;
      gap:16px; margin-bottom:14px;
    }
    .section-title{
      margin:0;
      font-family:"Playfair Display", serif;
      font-size:34px; line-height:1.08;
      letter-spacing:.01em;
      color:#221f29;
    }
    .section-sub{
      margin:8px 0 0;
      color:var(--muted);
      font-size:13.5px;
      line-height:1.55;
      max-width:80ch;
    }
    .title-line{
      width:110px; height:4px; border-radius:999px;
      background: linear-gradient(90deg, var(--sun4), var(--sun1), var(--sun2));
      opacity:.75;
      margin-top:10px;
    }
    @media (max-width: 700px){ .section-title{ font-size:28px; } }

    .grid{ display:grid; grid-template-columns: repeat(3, 1fr); gap:14px; }
    @media (max-width: 980px){ .grid{ grid-template-columns: repeat(2, 1fr); } }
    @media (max-width: 640px){ .grid{ grid-template-columns:1fr; } .btn{ padding:10px 12px; } }

    /* ====== MEDIA EN CARDS (MISMO TAMA√ëO) ====== */
    .media-frame{
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(20,19,26,.10);
      background: linear-gradient(135deg, rgba(90,169,255,.12), rgba(47,125,255,.08), rgba(15,88,214,.06));
    }
    .media-frame img{
      width:100%;
      height:100%;
      object-fit:cover;
      display:block;
      background:#111;
    }
    .card-media{
      height: var(--cardMediaH);
      margin-bottom:12px;
    }
    .media-placeholder{
      height:100%;
      width:100%;
      background:
        radial-gradient(220px 120px at 20% 30%, rgba(90,169,255,.22), transparent 60%),
        radial-gradient(260px 140px at 80% 50%, rgba(47,125,255,.14), transparent 62%),
        radial-gradient(240px 140px at 50% 120%, rgba(15,88,214,.10), transparent 65%);
    }

    .card{
      background: var(--card);
      border:1px solid rgba(20,19,26,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding:16px;
      display:flex; flex-direction:column;
      min-height: 320px;
      min-width:0;
      overflow:hidden;
    }
    .tag{
      width:max-content;
      font-size:11px;
      letter-spacing:.14em;
      text-transform:uppercase;
      font-weight:900;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(47,125,255,.12);
      color:#2b2832;
      border:1px solid rgba(47,125,255,.18);
      margin-bottom:10px;
    }
    .card h3{ margin:0; font-size:17px; font-weight:800; color:#221f29; line-height:1.25; }
    .meta{ margin-top:10px; display:flex; flex-wrap:wrap; gap:8px; min-width:0; }
    .meta .mini{
      font-size:12px;
      color:#2b2832;
      background: rgba(255,255,255,.90);
      border:1px solid rgba(20,19,26,.08);
      padding:6px 10px;
      border-radius:999px;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    /* ‚úÖ descripci√≥n corta en la card */
    .desc{
      margin:10px 0 0;
      color:#3c3646;
      font-size:13px;
      line-height:1.6;
      flex:1 1 auto;
      display:-webkit-box;
      -webkit-box-orient:vertical;
      -webkit-line-clamp:2;
      overflow:hidden;
      text-overflow:ellipsis;
      opacity:.92;
    }

    .price{ margin-top:10px; display:flex; flex-wrap:wrap; gap:10px; color:#221f29; font-size:13px; font-weight:700; }
    .actions{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    @media (max-width: 640px){ .actions{ gap:8px; } .actions .btn{ flex:1 1 auto; } }

    .box{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(20,19,26,.08);
      border-radius: 18px;
      box-shadow: 0 10px 22px rgba(20,19,26,.06);
      padding:14px;
      min-width:0;
    }
    .box h3{
      margin:0;
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-weight:900;
      color:#2b2832;
    }
    .box p{ margin:10px 0 0; color:#3c3646; font-size:13.5px; line-height:1.65; }

    .values{ margin-top:10px; display:flex; flex-direction:column; gap:10px; }
    .value{
      border:1px solid rgba(20,19,26,.08);
      background: rgba(255,255,255,.96);
      border-radius: 16px;
      padding:12px;
    }
    .value b{ display:block; font-size:13px; color:#221f29; font-weight:800; }
    .value span{ display:block; margin-top:2px; font-size:12.5px; color:#3c3646; line-height:1.55; }

    .about-cta{ margin-top:12px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .group-wrap{
      background: rgba(255,255,255,.84);
      border:1px solid rgba(20,19,26,.08);
      border-radius: 22px;
      box-shadow: var(--shadow2);
      padding:18px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){ .group-wrap{ grid-template-columns:1fr; } }
    .group-wrap h3{
      margin:0; font-family:"Playfair Display", serif;
      font-size:28px; color:#221f29; line-height:1.15;
    }
    .group-wrap p{
      margin:10px 0 0;
      color:#3c3646;
      font-size:14px;
      line-height:1.65;
      max-width:80ch;
    }
    .group-side{
      background: rgba(255,255,255,.92);
      border:1px solid rgba(20,19,26,.08);
      border-radius:18px;
      padding:14px;
    }
    .group-side b{
      display:block;
      font-size:12px;
      letter-spacing:.18em;
      text-transform:uppercase;
      color:#2b2832;
      margin-bottom:8px;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 12px; }
    .chip{
      font-size:12px;
      border:1px solid rgba(20,19,26,.08);
      background: rgba(255,255,255,.88);
      border-radius:999px;
      padding:6px 10px;
      color:#2b2832;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .group-actions{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    /* ===== ALOJAMIENTO (foto a la derecha y normal) ===== */
    .stay{
      background: rgba(255,255,255,.84);
      border:1px solid rgba(20,19,26,.08);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .stay-hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
      margin-bottom:14px;
    }
    .stay-hero h3{
      margin:0;
      font-family:"Playfair Display", serif;
      font-size:28px;
      color:#221f29;
      line-height:1.15;
    }
    .stay-hero p{
      margin:8px 0 0;
      color:#3c3646;
      font-size:14px;
      line-height:1.65;
      max-width:78ch;
    }
    .stay-photo{
      height: var(--cardMediaH);
    }
    @media (max-width: 980px){
      .stay-hero{ grid-template-columns:1fr; }
      .stay-photo{ height: var(--cardMediaH); }
    }
    .stay-list{ margin-top:14px; display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; }
    @media (max-width: 980px){ .stay-list{ grid-template-columns:1fr; } }
    .stay-item{
      border-radius: 18px;
      border:1px solid rgba(20,19,26,.08);
      background: rgba(255,255,255,.92);
      padding:14px;
      min-width:0;
    }
    .stay-item b{ display:block; font-size:13px; color:#221f29; font-weight:800; }
    .stay-item span{ display:block; margin-top:4px; font-size:12.5px; color:#3c3646; line-height:1.5; }
    .stay-actions{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }

    .note{ font-size:12px; color:var(--muted); line-height:1.5; }

    .ally{
      background: rgba(255,255,255,.84);
      border:1px solid rgba(20,19,26,.08);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding:18px;
    }
    .ally-grid{ display:grid; grid-template-columns: 1fr 1fr; gap:14px; align-items:start; }
    @media (max-width: 980px){ .ally-grid{ grid-template-columns:1fr; } }
    .ally h3{ margin:0; font-family:"Playfair Display", serif; font-size:28px; color:#221f29; line-height:1.12; }
    .ally .sub{ margin:8px 0 0; color:#3c3646; font-size:14px; line-height:1.65; max-width:80ch; }
    .ally .bullets{ margin:12px 0 0; padding:0; list-style:none; display:grid; gap:10px; }
    .ally .bullets li{
      border:1px solid rgba(20,19,26,.08);
      background: rgba(255,255,255,.92);
      border-radius: 16px;
      padding:12px;
      color:#3c3646;
      font-size:13px;
      line-height:1.55;
    }
    .ally .bullets b{ color:#221f29; }

    label{ display:block; font-size:12px; color:var(--muted); margin:10px 0 6px; }
    input, textarea, select{
      width:100%;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(20,19,26,.10);
      outline:none;
      font-size:14px;
      background:#fff;
      color:#221f29;
      min-width:0;
    }
    textarea{ min-height:96px; resize:vertical; }
    input:focus, textarea:focus, select:focus{
      border-color: rgba(47,125,255,.55);
      box-shadow: 0 0 0 4px rgba(47,125,255,.14);
    }

    footer{
      padding:26px 0 52px;
      text-align:center;
      color:var(--muted);
      font-size:12px;
      border-top:1px solid rgba(20,19,26,.06);
    }

    /* ===== BACKDROP + MODALES ===== */
    .backdrop{
      position:fixed; inset:0;
      background: rgba(20,19,26,.22);
      display:none;
      align-items:center; justify-content:center;
      padding:18px;
      z-index:60;
      backdrop-filter: blur(6px);

      overscroll-behavior: contain;
      touch-action: none;
    }

    .modal{
      width:min(640px, 96vw);
      max-height: calc(100dvh - 36px);
      background: rgba(255,255,255,.94);
      border:1px solid rgba(20,19,26,.10);
      border-radius: 24px;
      box-shadow: 0 24px 70px rgba(20,19,26,.18);
      overflow:hidden;

      display:flex;
      flex-direction:column;
    }
    .modal-head{
      padding:14px 16px;
      border-bottom:1px solid rgba(20,19,26,.08);
      display:flex; justify-content:space-between; gap:10px; align-items:flex-start;
      background: linear-gradient(135deg, rgba(166,212,255,.30), rgba(90,169,255,.16), rgba(47,125,255,.10));
      flex: 0 0 auto;
    }
    .modal-head h4{
      margin:0;
      font-size:12.5px;
      letter-spacing:.18em;
      text-transform:uppercase;
      font-weight:900;
      color:#2b2832;
    }
    .modal-head p{ margin:6px 0 0; color:#3c3646; font-size:12.5px; line-height:1.5; }
    .x{
      width:40px; height:40px;
      border-radius:14px;
      border:1px solid rgba(20,19,26,.10);
      background: rgba(255,255,255,.78);
      cursor:pointer;
      font-size:18px;
      line-height:1;
      flex:0 0 auto;
      color:#221f29;
    }

    .modal-body{
      padding:16px;
      flex: 1 1 auto;
      overflow:auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior: contain;
      touch-action: pan-y;
    }

    .meta-row{ display:flex; flex-wrap:wrap; gap:8px; margin-bottom:10px; min-width:0; }
    .modal-actions{ margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    @media (max-width: 640px){ .modal-actions .btn{ flex:1 1 auto; } }

    .info{
      margin-top:10px;
      padding:12px;
      border-radius: 16px;
      background: rgba(255,255,255,.90);
      border:1px solid rgba(20,19,26,.08);
      color:#3c3646;
      font-size:13px;
      line-height:1.65;
      white-space:pre-line;
    }

    .video-modal{
      width: min(420px, 94vw);
      aspect-ratio: 9 / 16;
      border-radius: 24px;
      overflow:hidden;
      background: rgba(255,255,255,.94);
      border:1px solid rgba(20,19,26,.10);
      box-shadow: 0 24px 70px rgba(20,19,26,.18);
      position:relative;
    }
    .video-modal video{ width:100%; height:100%; object-fit: cover; background:#111; display:block; }
    .video-modal .vm-close{
      position:absolute; top:10px; right:10px;
      width:42px; height:42px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.26);
      background: rgba(20,19,26,.42);
      color:#fff;
      cursor:pointer;
      font-size:18px;
      backdrop-filter: blur(8px);
      display:grid; place-items:center;
      z-index:2;
    }

    .toast{
      position:fixed;
      left:50%; bottom:22px;
      transform:translateX(-50%);
      background: rgba(255,255,255,.94);
      border:1px solid rgba(20,19,26,.10);
      border-radius:999px;
      padding:12px 14px;
      box-shadow: 0 18px 40px rgba(20,19,26,.14);
      display:none;
      z-index:80;
      color:#221f29;
      font-size:13px;
      max-width:92vw;
      text-align:center;
    }

    /* FIX logo CUADRADO (mata cualquier c√≠rculo) */
    .brand .logo,
    .brand .logo img{
      border-radius: 0 !important;
      clip-path: none !important;
      -webkit-clip-path: none !important;
      mask-image: none !important;
      -webkit-mask-image: none !important;
    }

    .brand .logo{
      width: 56px;
      height: 56px;
      overflow: hidden; /* recorte cuadrado */
    }

    .brand .logo img{
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }
  </style>
</head>

<body>
  <!-- ‚úÖ META PIXEL (NOSCRIPT VA AQU√ç, APENAS ABRE BODY) -->
  <noscript><img height="1" width="1" style="display:none"
    src="https://www.facebook.com/tr?id=2988189631474288&ev=PageView&noscript=1"
  /></noscript>
  <!-- ‚úÖ FIN META PIXEL (NOSCRIPT) -->

  <header>
    <div class="container">
      <div class="nav">
        <a class="brand" href="#inicio" aria-label="Vacaciones en el Sur">
          <!-- ‚úÖ AQU√ç VA LA FOTO DE PERFIL DEL LOGO -->
          <div class="logo">
            <img src="Fotos/logo.jpg" alt="Vacaciones en el Sur">
          </div>
          <div>
            <h1>Vacaciones en el Sur</h1>
            <small>Valdivia ‚Ä¢ Regi√≥n de los R√≠os</small>
          </div>
        </a>

        <nav aria-label="Navegaci√≥n principal">
          <ul>
            <li><a href="#quienes-somos">Qui√©nes somos</a></li>
            <li><a href="#grupos-empresas">Grupos/Empresas</a></li>
            <li><a href="#tours-fluviales">Tours fluviales</a></li>
            <li><a href="#tours-terrestres">Tours terrestres</a></li>
            <li><a href="#alojamiento">Alojamiento</a></li>
            <li><a href="#alianza">Alianza</a></li>
          </ul>
        </nav>

        <button class="menu-btn" id="menuBtn" aria-label="Abrir men√∫">‚ò∞</button>
      </div>
    </div>
  </header>

  <div class="drawer-backdrop" id="drawerBackdrop" aria-hidden="true">
    <div class="drawer" role="dialog" aria-modal="true" aria-label="Men√∫">
      <div class="drawer-head">
        <b>Men√∫</b>
        <button class="drawer-close" id="drawerClose" aria-label="Cerrar">√ó</button>
      </div>
      <div class="drawer-body">
        <a class="drawer-link" href="#quienes-somos" data-drawer-link>Qui√©nes somos</a>
        <a class="drawer-link" href="#grupos-empresas" data-drawer-link>Grupos/Empresas</a>
        <a class="drawer-link" href="#tours-fluviales" data-drawer-link>Tours fluviales</a>
        <a class="drawer-link" href="#tours-terrestres" data-drawer-link>Tours terrestres</a>
        <a class="drawer-link" href="#alojamiento" data-drawer-link>Alojamiento</a>
        <a class="drawer-link" href="#alianza" data-drawer-link>Alianza</a>
        <div class="drawer-note">üìå Reservas por formulario (sin redirecci√≥n). Te escribimos por WhatsApp para coordinar.</div>
      </div>
    </div>
  </div>

  <main id="inicio">
    <div class="container">
      <div class="hero">
        <div class="hero-box">
          <div class="hero-content">
            <div class="hero-grid">
              <div class="hero-media">
                <div class="video-card">
                  <div class="video-wrap">
                    <video id="heroVideo" playsinline controls preload="metadata"></video>
                    <button class="video-play" id="heroPlayBtn" type="button">‚ñ∂ Ver video</button>
                    <button class="video-sound" id="heroSoundBtn" type="button">üîä Sonido</button>
                  </div>
                  <p class="video-hint">Video vertical. <b>Tocas ‚ÄúVer video‚Äù</b> y se abre en formato reels.</p>
                </div>
              </div>

              <div class="hero-side">
                <div class="side-card">
                  <div class="side-top">
                    <div class="kicker"><span class="dot"></span> Turismo ‚Ä¢ Experiencias reales</div>
                    <h2 class="hero-title">
                      Vacaciones en el Sur<br>
                      de <span class="script">Chile</span>
                    </h2>
                    <p class="hero-sub">
                      R√≠os, humedales, castillos, selva valdiviana y rutas full day.
                      T√∫ env√≠as la solicitud ac√° y <b>nosotros te escribimos por WhatsApp</b> para coordinar horarios y pagos.
                    </p>
                  </div>

                  <div class="side-scroll" id="quienes-somos">
                    <h2 style="margin:0;font-family:'Playfair Display',serif;font-size:30px;line-height:1.1;color:#221f29;">
                      Qui√©nes somos
                    </h2>
                    <div class="title-line" style="margin:10px 0 6px;"></div>
                    <div style="color:var(--muted);font-size:13.5px;line-height:1.5;margin-bottom:12px;">
                      Turismo con prop√≥sito: aut√©ntico, accesible y memorable.
                    </div>

                    <div class="box">
                      <h3>Misi√≥n</h3>
                      <p>
                        Somos un puente de soluciones entre los viajeros y los encantos del sur, conect√°ndolos con experiencias aut√©nticas,
                        accesibles y memorables. Creemos en un turismo con prop√≥sito, dando valor a la cultura local, sus emprendimientos y respetando
                        el entorno natural.
                      </p>

                      <h3 style="margin-top:12px;">Visi√≥n</h3>
                      <p>
                        Ser l√≠deres en innovaci√≥n tur√≠stica en la Regi√≥n de los R√≠os, transformando la forma en que las personas exploran nuestra regi√≥n
                        mediante experiencias fluviales y terrestres √∫nicas, sostenibles y con alto impacto social.
                      </p>

                      <h3 style="margin-top:12px;">Prop√≥sito</h3>
                      <p>
                        Crecer entregando valor en lo que hacemos, a nuestros colaboradores y entorno.
                      </p>

                      <h3 style="margin-top:12px;">Qu√© hacemos</h3>
                      <div class="values" style="margin-top:10px;">
                        <div class="value"><b>Tours fluviales</b><span>Castillos, santuarios, humedales y postales.</span></div>
                        <div class="value"><b>Tours terrestres</b><span>Termas, parques y rutas full day.</span></div>
                        <div class="value"><b>Alojamiento</b><span>Cotizamos seg√∫n zona, fechas y capacidad.</span></div>
                      </div>

                      <div class="about-cta">
                        <button class="btn btn-primary" onclick="openMeeting()">Agendar reuni√≥n</button>
                        <button class="btn btn-ghost" onclick="openReserve({ tipo:'Consulta', nombre:'Consulta general', id:'general-1' })">Enviar consulta</button>
                      </div>
                    </div>
                  </div>

                </div>
              </div>
            </div><!-- hero-grid -->
          </div>
        </div>
      </div>

      <section id="grupos-empresas" style="padding-top:14px;">
        <div class="section-head">
          <div>
            <h2 class="section-title">Grupos, colegios y empresas</h2>
            <div class="title-line"></div>
            <p class="section-sub">Si viene harta gente, la diferencia es la coordinaci√≥n. Hag√°moslo bien desde el principio.</p>
          </div>
        </div>

        <div class="group-wrap">
          <div>
            <h3>Planificaci√≥n con calma, para que el grupo disfrute</h3>
            <p>
              Un grupo necesita organizaci√≥n y alguien confiable al otro lado.
              Te ayudamos a planificar ruta, horarios, puntos clave y coordinaci√≥n para que <b>t√∫ te despreocupes</b> y el grupo solo venga a disfrutar.
            </p>
          </div>

          <div class="group-side">
            <b>Contacto r√°pido</b>
            <div class="chips">
              <span class="chip">üìå Colegio / Universidad / Evento / Empresa</span>
              <span class="chip">üí¨ Te contactamos por WhatsApp</span>
              <span class="chip">üìç Chile</span>
            </div>
            <div class="group-actions">
              <button class="btn btn-primary" onclick="openMeeting()">Agendar reuni√≥n</button>
              <button class="btn btn-ghost" onclick="openReserve({ tipo:'Consulta', nombre:'Consulta grupos/empresa', id:'group-1' })">Enviar consulta</button>
            </div>
          </div>
        </div>
      </section>

      <section id="tours-fluviales">
        <div class="section-head">
          <div>
            <h2 class="section-title">Tours fluviales</h2>
            <div class="title-line"></div>
            <p class="section-sub">Valdivia por agua: castillos, santuarios, humedales, postales.</p>
          </div>
        </div>
        <div class="grid" id="grid-fluviales"></div>
      </section>

      <section id="tours-terrestres">
        <div class="section-head">
          <div>
            <h2 class="section-title">Tours terrestres</h2>
            <div class="title-line"></div>
            <p class="section-sub">Full day, termas, parques y rutas: naturaleza + cultura.</p>
          </div>
        </div>
        <div class="grid" id="grid-terrestres"></div>
      </section>

      <section id="alojamiento">
        <div class="section-head">
          <div>
            <h2 class="section-title">Alojamiento</h2>
            <div class="title-line"></div>
            <p class="section-sub">Opciones reales seg√∫n zona, fechas y capacidad.</p>
          </div>
        </div>

        <div class="stay">
          <div class="stay-hero">
            <div>
              <h3>Tenemos estas opciones de alojamiento</h3>
              <p>Sin cat√°logo infinito. T√∫ mandas tu solicitud y te respondemos con alternativas que calzan contigo.</p>

              <div class="stay-actions">
                <button class="btn btn-primary" onclick="openReserve({ tipo:'Alojamiento', nombre:'Solicitud de alojamiento', id:'stay-1' })">
                  Solicitar alojamiento
                </button>
                <span class="note">* Se env√≠a al sistema.</span>
              </div>
            </div>

            <div class="stay-photo media-frame" aria-label="Foto de alojamiento">
              <img src="Fotos/Alojamientos.jpg" alt="Alojamiento en el sur" loading="lazy">
            </div>
          </div>

          <div class="stay-list">
            <div class="stay-item">
              <b>Caba√±as con tinaja, quincho y vista incre√≠ble</b>
              <span>Ideal para desconectarse. Pareja o grupo peque√±o.</span>
            </div>
            <div class="stay-item">
              <b>Casas de turismo, hoteles en la costa</b>
              <span>Niebla / costa y alrededores.</span>
            </div>
            <div class="stay-item">
              <b>Opciones low cost</b>
              <span>Limpio, seguro, bien ubicado.</span>
            </div>
          </div>
        </div>
      </section>

      <section id="alianza">
        <div class="section-head">
          <div>
            <h2 class="section-title">Alianza y partners</h2>
            <div class="title-line"></div>
            <p class="section-sub">Para alojamientos, hoteles, tours, transporte y servicios tur√≠sticos que quieran trabajar con nosotros.</p>
          </div>
        </div>

        <div class="ally">
          <div class="ally-grid">
            <div>
              <h3>Promociona tu marca ac√°</h3>
              <p class="sub">
                Si eres parte del rubro turismo y quieres sumar m√°s visibilidad, clientes o colaboraci√≥n real, d√©janos tus datos y armamos una alianza.
              </p>
              <ul class="bullets">
                <li><b>M√°s alcance</b> ‚Äî Te presentamos a viajeros que ya est√°n buscando.</li>
                <li><b>Colaboraci√≥n real</b> ‚Äî Armamos rutas y experiencias combinadas.</li>
                <li><b>Orden y coordinaci√≥n</b> ‚Äî Todo por sistema para responder r√°pido y sin perder leads.</li>
              </ul>
              <p class="sub" style="margin-top:12px;">
                * Solo rubro turismo: alojamiento, hoteler√≠a, gastronom√≠a tur√≠stica, transporte, gu√≠as, experiencias, operadores.
              </p>
            </div>

            <div>
              <form id="allyForm">
                <!-- ‚úÖ WRAP para ocultar campos si ya envi√≥ -->
                <div id="allyFieldsWrap">
                  <label for="a_nombre">Tu nombre</label>
                  <input id="a_nombre" placeholder="Nombre y apellido" autocomplete="name" />

                  <label for="a_email">Tu correo electr√≥nico</label>
                  <input id="a_email" type="email" placeholder="correo@ejemplo.com" autocomplete="email" />

                  <label for="a_tel">Tu tel√©fono (WhatsApp)</label>
                  <input id="a_tel" placeholder="+56 9 1234 5678" autocomplete="tel" />

                  <label for="a_localidad">¬øD√≥nde desarrollas tu negocio? (localidad)</label>
                  <input id="a_localidad" placeholder="Ej: Valdivia / Niebla / centro" />

                  <label for="a_marca">Nombre de tu marca</label>
                  <input id="a_marca" placeholder="Nombre comercial" />

                  <label for="a_rubro">Rubro</label>
                  <select id="a_rubro">
                    <option value="">Selecciona‚Ä¶</option>
                    <option>Alojamiento / Caba√±as</option>
                    <option>Hotel / Hostal</option>
                    <option>Tour operador / Experiencias</option>
                    <option>Transporte</option>
                    <option>Gastronom√≠a tur√≠stica</option>
                    <option>Otro servicio tur√≠stico</option>
                  </select>

                  <label for="a_msg">Cu√©ntanos a qu√© se dedica tu negocio</label>
                  <textarea id="a_msg" placeholder="Qu√© ofreces, capacidad, temporada, informaci√≥n clave"></textarea>
                </div>

                <!-- ‚úÖ acciones con id (para ocultarlas al bloquear) -->
                <div class="modal-actions" id="allyActions">
                  <button class="btn btn-primary" id="allySendBtn" type="button" onclick="submitAlliance()">Enviar</button>
                  <button class="btn btn-ghost" id="allyClearBtn" type="button" onclick="clearAlliance()">Limpiar</button>
                </div>

                <div class="note" id="allyNote" style="margin-top:10px;"></div>
              </form>
            </div>
          </div>
        </div>
      </section>

      <footer>
        ¬© <span id="year"></span> Vacaciones en el Sur ‚Äî Regi√≥n de los R√≠os
      </footer>
    </div>
  </main>

  <!-- Modal Reserva -->
  <div class="backdrop" id="reserveBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div>
          <h4 id="reserveTitle">Enviar solicitud</h4>
          <p>Deja tus datos. Te escribimos por WhatsApp para coordinar horarios y pagos.</p>
        </div>
        <button class="x" onclick="closeReserve()" aria-label="Cerrar">√ó</button>
      </div>
      <div class="modal-body">
        <div class="meta-row" id="reserveMeta"></div>

        <!-- ‚úÖ WRAP para ocultar campos si ya envi√≥ -->
        <div id="reserveFieldsWrap">
          <label for="r_nombre">Nombre</label>
          <input id="r_nombre" placeholder="Tu nombre" autocomplete="name" />

          <label for="r_email">Correo electr√≥nico (opcional)</label>
          <input id="r_email" type="email" placeholder="correo@ejemplo.com" autocomplete="email" />

          <label for="r_tel">Tel√©fono (WhatsApp)</label>
          <input id="r_tel" placeholder="+56 9 1234 5678" autocomplete="tel" />

          <!-- ‚úÖ TOUR: adultos/ni√±os/fecha -->
          <div id="tourFieldsRow" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:10px;">
            <div>
              <label for="r_personas">N¬∞ personas (opcional)</label>
              <input id="r_personas" placeholder="Ej: 2" inputmode="numeric" />
            </div>
            <div>
              <label for="r_ninos">N¬∞ ni√±os (opcional)</label>
              <input id="r_ninos" placeholder="Ej: 0" inputmode="numeric" />
            </div>
            <div>
              <label for="r_fecha">Fecha tentativa (opcional)</label>
              <input id="r_fecha" type="date" />
            </div>
          </div>

          <!-- ‚úÖ ALOJAMIENTO: preguntas extra (sin cuna / sin movilidad reducida) -->
          <div id="stayFields" style="display:none;margin-top:6px;">
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div>
                <label for="s_checkin">Fecha llegada (check-in)</label>
                <input id="s_checkin" type="date" />
              </div>
              <div>
                <label for="s_checkout">Fecha salida (check-out)</label>
                <input id="s_checkout" type="date" />
              </div>
            </div>

            <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;">
              <div>
                <label for="s_adultos">N¬∞ adultos (opcional)</label>
                <input id="s_adultos" placeholder="Ej: 2" inputmode="numeric" />
              </div>
              <div>
                <label for="s_ninos">N¬∞ ni√±os (opcional)</label>
                <input id="s_ninos" placeholder="Ej: 0" inputmode="numeric" />
              </div>
            </div>

            <label for="s_zona">Zona / localidad</label>
            <input id="s_zona" placeholder="Ej: Valdivia / Niebla / Panguipulli" />

            <label for="s_tipo">Tipo de alojamiento</label>
            <select id="s_tipo">
              <option value="">Selecciona‚Ä¶</option>
              <option value="Caba√±a">Caba√±a</option>
              <option value="Casa">Casa</option>
              <option value="Hotel">Hotel</option>
              <option value="Hostal">Hostal</option>
              <option value="Departamento">Departamento</option>
              <option value="Low cost">Low cost</option>
              <option value="Otro">Otro</option>
            </select>

            <label for="s_presupuesto">Presupuesto aprox (opcional)</label>
            <input id="s_presupuesto" placeholder="Ej: 60.000 por noche / total" />

            <label for="s_mascotas">¬øVan con mascota?</label>
            <select id="s_mascotas">
              <option value="">Selecciona‚Ä¶</option>
              <option value="No">No</option>
              <option value="S√≠">S√≠</option>
            </select>
          </div>

          <label for="r_msg">Mensaje (opcional)</label>
          <textarea id="r_msg" placeholder="Ej: vamos con ni√±os / disponibilidad / dudas"></textarea>
        </div>

        <!-- ‚úÖ acciones con id (para ocultarlas al bloquear) -->
        <div class="modal-actions" id="reserveActions">
          <button class="btn btn-primary" id="reserveSendBtn" onclick="submitReserve()">Enviar solicitud</button>
          <button class="btn btn-ghost" onclick="closeReserve()">Cancelar</button>
        </div>

        <div class="note" id="reserveNote" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- Modal Info -->
  <div class="backdrop" id="infoBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div>
          <h4 id="infoTitle">Detalle</h4>
          <p id="infoSubtitle">Informaci√≥n completa</p>
        </div>
        <button class="x" onclick="closeInfo()" aria-label="Cerrar">√ó</button>
      </div>
      <div class="modal-body">
        <div class="meta-row" id="infoMeta"></div>
        <div class="info" id="infoBody"></div>
        <div class="modal-actions">
          <button class="btn btn-primary" onclick="infoReserve()">Reservar este tour</button>
          <button class="btn btn-ghost" onclick="closeInfo()">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Reuni√≥n (SIN d√≠a/hora) -->
  <div class="backdrop" id="meetBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true">
      <div class="modal-head">
        <div>
          <h4>Agendar reuni√≥n</h4>
          <p>Rellenas el formulario y <b>te contactamos por WhatsApp</b> para coordinar.</p>
        </div>
        <button class="x" onclick="closeMeeting()" aria-label="Cerrar">√ó</button>
      </div>

      <div class="modal-body">
        <div class="meta-row">
          <span class="chip">üìå Colegio / Universidad / Evento / Empresa</span>
          <span class="chip">üí¨ Te contactamos por WhatsApp</span>
        </div>

        <!-- ‚úÖ WRAP para ocultar campos si ya envi√≥ -->
        <div id="meetFieldsWrap">
          <label for="m_tipo">¬øQu√© est√°s organizando?</label>
          <select id="m_tipo">
            <option value="">Selecciona‚Ä¶</option>
            <option value="Colegio">Colegio</option>
            <option value="Universidad">Universidad</option>
            <option value="Evento">Evento</option>
            <option value="Empresa">Empresa</option>
          </select>

          <label for="m_nombre">Nombre</label>
          <input id="m_nombre" placeholder="Tu nombre" autocomplete="name" />

          <label for="m_email">Correo electr√≥nico</label>
          <input id="m_email" type="email" placeholder="correo@ejemplo.com" autocomplete="email" />

          <label for="m_tel">Tel√©fono (WhatsApp)</label>
          <input id="m_tel" placeholder="+56 9 1234 5678" autocomplete="tel" />

          <label for="m_tema">Tema (opcional)</label>
          <textarea id="m_tema" placeholder="Ej: paseo de colegio / navegaci√≥n privada / evento corporativo"></textarea>
        </div>

        <!-- ‚úÖ acciones con id (para ocultarlas al bloquear) -->
        <div class="modal-actions" id="meetActions">
          <button class="btn btn-primary" id="meetSendBtn" onclick="submitMeeting()">Enviar</button>
          <button class="btn btn-ghost" onclick="closeMeeting()">Cancelar</button>
        </div>

        <div class="note" id="meetNote" style="margin-top:10px;"></div>
      </div>
    </div>
  </div>

  <!-- Modal Video -->
  <div class="backdrop" id="videoBackdrop" aria-hidden="true">
    <div class="video-modal" role="dialog" aria-modal="true" aria-label="Video">
      <button class="vm-close" type="button" onclick="closeVideo()" aria-label="Cerrar">√ó</button>
      <video id="bigVideo" playsinline controls preload="metadata"></video>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    /***** CONFIG *****/
    const WEBHOOK_URL = "https://n8n-n8n.bvil2a.easypanel.host/webhook/2e98cf7f-b5fb-490c-8dac-05274a1d59e8";
    const HERO_VIDEO_URL = "video/video.mp4";

    /***** ‚úÖ SINGLE SUBMIT (anti doble env√≠o + bloqueo por dispositivo con TTL) *****/
    const FORM_LOCK_TTL_HOURS = 24; // üëà c√°mbialo si quieres (ej: 2, 12, 168)
    const FORM_LOCK_TTL_MS = FORM_LOCK_TTL_HOURS * 60 * 60 * 1000;

    /***** ‚úÖ SINGLE SUBMIT (reuni√≥n/alianza) + ‚úÖ RATE LIMIT (reservas) *****/
const FORM_LOCK_TTL_HOURS = 24;
const FORM_LOCK_TTL_MS = FORM_LOCK_TTL_HOURS * 60 * 60 * 1000;

// ‚úÖ Reuni√≥n / Alianza siguen con 1 env√≠o por 24h
const LOCK_KEYS = {
  reunion: "vds_lock_reunion_v1",
  alianza: "vds_lock_alianza_v1"
};

function readLock(key){
  try{
    const raw = localStorage.getItem(key);
    if(!raw) return null;
    const data = JSON.parse(raw);
    if(!data || !data.ts) return null;
    if(Date.now() - data.ts > FORM_LOCK_TTL_MS){
      localStorage.removeItem(key);
      return null;
    }
    return data;
  }catch(e){ return null; }
}
function isLocked(key){ return !!readLock(key); }
function writeLock(key, extra){
  try{
    localStorage.setItem(key, JSON.stringify({ ts: Date.now(), ...(extra||{}) }));
  }catch(e){}
}

// ‚úÖ Reservas: hasta 10 por 24h (por dispositivo)
const RESERVE_LIMIT_MAX = 10;
const RESERVE_LIMIT_HOURS = 24;
const RESERVE_LIMIT_MS = RESERVE_LIMIT_HOURS * 60 * 60 * 1000;
const RESERVE_QUOTA_KEY = "vds_quota_reserva_v1";

function readReserveQuota(){
  const now = Date.now();
  try{
    const raw = localStorage.getItem(RESERVE_QUOTA_KEY);
    if(!raw){
      const fresh = { window_start: now, count: 0 };
      localStorage.setItem(RESERVE_QUOTA_KEY, JSON.stringify(fresh));
      return fresh;
    }
    const q = JSON.parse(raw) || {};
    const start = Number(q.window_start);
    const count = Number(q.count);

    if(!Number.isFinite(start) || !Number.isFinite(count)){
      const fresh = { window_start: now, count: 0 };
      localStorage.setItem(RESERVE_QUOTA_KEY, JSON.stringify(fresh));
      return fresh;
    }
    if(now - start >= RESERVE_LIMIT_MS){
      const fresh = { window_start: now, count: 0 };
      localStorage.setItem(RESERVE_QUOTA_KEY, JSON.stringify(fresh));
      return fresh;
    }
    return { window_start: start, count };
  }catch(e){
    const fresh = { window_start: now, count: 0 };
    try{ localStorage.setItem(RESERVE_QUOTA_KEY, JSON.stringify(fresh)); }catch{}
    return fresh;
  }
}

function isReserveRateLimited(){
  const q = readReserveQuota();
  return q.count >= RESERVE_LIMIT_MAX;
}
function reserveRemaining(){
  const q = readReserveQuota();
  return Math.max(0, RESERVE_LIMIT_MAX - q.count);
}
function reserveTimeLeftMs(){
  const q = readReserveQuota();
  return Math.max(0, RESERVE_LIMIT_MS - (Date.now() - q.window_start));
}
function prettyMs(ms){
  const total = Math.ceil(ms/1000);
  const h = Math.floor(total/3600);
  const m = Math.floor((total%3600)/60);
  return `${h}h ${m}m`;
}
function reserveRegisterSuccess(submissionId){
  const q = readReserveQuota();
  const next = {
    window_start: q.window_start,
    count: Math.min(RESERVE_LIMIT_MAX, q.count + 1),
    last_ts: Date.now(),
    last_submission_id: submissionId || null
  };
  try{ localStorage.setItem(RESERVE_QUOTA_KEY, JSON.stringify(next)); }catch{}
  return next;
}


    function readLock(key){
      try{
        const raw = localStorage.getItem(key);
        if(!raw) return null;
        const data = JSON.parse(raw);
        if(!data || !data.ts) return null;
        if(Date.now() - data.ts > FORM_LOCK_TTL_MS){
          localStorage.removeItem(key);
          return null;
        }
        return data;
      }catch(e){ return null; }
    }

    function isLocked(key){ return !!readLock(key); }

    function writeLock(key, extra){
      try{
        localStorage.setItem(key, JSON.stringify({ ts: Date.now(), ...(extra||{}) }));
      }catch(e){}
    }

    function submissionId(){
      try{ return crypto.randomUUID(); }
      catch(e){ return "sub_" + Math.random().toString(36).slice(2) + "_" + Date.now().toString(36); }
    }

    async function postJSON(url, payload, timeoutMs=12000){
      const ctrl = new AbortController();
      const t = setTimeout(() => ctrl.abort(), timeoutMs);
      try{
        const res = await fetch(url, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload),
          signal: ctrl.signal
        });
        if(!res.ok) throw new Error("HTTP " + res.status);
        return true;
      } finally {
        clearTimeout(t);
      }
    }

    function applyReserveLockState(){
  const wrap = document.getElementById("reserveFieldsWrap");
  const actions = document.getElementById("reserveActions");
  const note = document.getElementById("reserveNote");
  const btn = document.getElementById("reserveSendBtn");

  const blocked = isReserveRateLimited();
  const remaining = reserveRemaining();

  if(blocked){
    if(wrap) wrap.style.display = "none";
    if(actions) actions.style.display = "none";
    if(note) note.textContent =
      `üö´ L√≠mite alcanzado: ${RESERVE_LIMIT_MAX} solicitudes en ${RESERVE_LIMIT_HOURS}h (por dispositivo). ` +
      `Vuelve a intentar en ${prettyMs(reserveTimeLeftMs())}.`;
    if(btn){ btn.disabled = true; btn.textContent = "L√≠mite alcanzado"; }
    return true;
  }else{
    if(wrap) wrap.style.display = "block";
    if(actions) actions.style.display = "flex";

    if(note){
      const base = note.dataset.baseText || "";
      const extra = `‚úÖ Te quedan ${remaining} solicitudes dentro de ${RESERVE_LIMIT_HOURS}h (por dispositivo).`;
      note.textContent = base ? (base + " " + extra) : extra;
    }

    if(btn){ btn.disabled = false; btn.textContent = "Enviar solicitud"; }
    return false;
  }
}


    function applyMeetLockState(){
      const locked = isLocked(LOCK_KEYS.reunion);
      const wrap = document.getElementById("meetFieldsWrap");
      const actions = document.getElementById("meetActions");
      const note = document.getElementById("meetNote");
      const btn = document.getElementById("meetSendBtn");

      if(locked){
        if(wrap) wrap.style.display = "none";
        if(actions) actions.style.display = "none";
        if(note) note.textContent = `‚úÖ Ya recibimos una solicitud de reuni√≥n desde este dispositivo (bloqueo ${FORM_LOCK_TTL_HOURS}h). Si necesitas reprogramar, contesta por WhatsApp cuando te escribamos.`;
        if(btn){ btn.disabled = true; btn.textContent = "Solicitud ya enviada"; }
        return true;
      }else{
        if(wrap) wrap.style.display = "block";
        if(actions) actions.style.display = "flex";
        if(btn){ btn.disabled = false; btn.textContent = "Enviar"; }
        return false;
      }
    }

    function applyAllianceLockState(){
      const locked = isLocked(LOCK_KEYS.alianza);
      const wrap = document.getElementById("allyFieldsWrap");
      const actions = document.getElementById("allyActions");
      const note = document.getElementById("allyNote");
      const send = document.getElementById("allySendBtn");
      const clear = document.getElementById("allyClearBtn");

      if(locked){
        if(wrap) wrap.style.display = "none";
        if(actions) actions.style.display = "none";
        if(note) note.textContent = `‚úÖ Alianza recibida desde este dispositivo (bloqueo ${FORM_LOCK_TTL_HOURS}h). Te contactamos pronto.`;
        if(send){ send.disabled = true; send.textContent = "Enviado"; }
        if(clear){ clear.disabled = true; }
        return true;
      }else{
        if(wrap) wrap.style.display = "block";
        if(actions) actions.style.display = "flex";
        if(send){ send.disabled = false; send.textContent = "Enviar"; }
        if(clear){ clear.disabled = false; }
        return false;
      }
    }

    /***** HORARIO CHILE (America/Santiago) *****/
    function nowChileISO(){
      const s = new Date().toLocaleString("sv-SE", { timeZone: "America/Santiago" });
      return s.replace(" ", "T"); // "YYYY-MM-DDTHH:mm:ss"
    }

    /* ‚úÖ FECHAS YYYY-MM-DD SEG√öN CHILE + offset d√≠as */
    function chileDateYMDPlus(days=0){
      const dstr = new Date().toLocaleDateString("sv-SE", { timeZone: "America/Santiago" }); // YYYY-MM-DD
      const parts = String(dstr).split("-").map(Number);
      const y = parts[0], m = parts[1], d = parts[2];
      const dt = new Date(Date.UTC(y, m-1, d + (days||0)));
      return dt.toISOString().slice(0,10);
    }

    function minDateForTipo(tipo){
      if(tipo === "Tour fluvial") return chileDateYMDPlus(0);
      if(tipo === "Tour terrestre" || tipo === "Alojamiento") return chileDateYMDPlus(1);
      return chileDateYMDPlus(0);
    }

    /***** META PIXEL HELPERS (eventos) *****/
    const META_CURRENCY = "CLP";

    function trackMeta(eventName, params){
      try{
        if(typeof fbq === "function") fbq("track", eventName, params || {});
      }catch(e){}
    }

    function getNumericValueFromTour(t){
      const v = Number(t?.precio_adulto);
      return Number.isFinite(v) && v > 0 ? v : null;
    }

    /***** LOCK SCROLL (iOS/Android friendly) *****/
    let __lockCount = 0;
    let __scrollY = 0;

    function lockScroll(){
      __lockCount++;
      if(__lockCount > 1) return;

      __scrollY = window.scrollY || 0;
      document.body.style.position = "fixed";
      document.body.style.top = `-${__scrollY}px`;
      document.body.style.left = "0";
      document.body.style.right = "0";
      document.body.style.width = "100%";
    }

    function unlockScroll(){
      __lockCount = Math.max(0, __lockCount - 1);
      if(__lockCount > 0) return;

      const root = document.documentElement;
      const prev = root.style.scrollBehavior;
      root.style.scrollBehavior = "auto";

      const y = __scrollY;

      document.body.style.position = "";
      document.body.style.top = "";
      document.body.style.left = "";
      document.body.style.right = "";
      document.body.style.width = "";

      window.scrollTo({ top: y, left: 0, behavior: "auto" });

      requestAnimationFrame(() => { root.style.scrollBehavior = prev; });
    }

    function resetModalScroll(backdropId){
      const b = document.getElementById(backdropId);
      const body = b ? b.querySelector(".modal-body") : null;
      if(body) body.scrollTop = 0;
    }

    /***** CONDICIONES (cat√°logo terrestre) ‚Äî sin datos bancarios p√∫blicos *****/
    const CONDICIONES_RESERVA_TERRESTRES = [
      "Confirmaci√≥n con abono m√≠nimo de $20.000 por persona (datos de pago se coordinan al confirmar).",
      "Saldo a pagar a m√°s tardar el d√≠a PREVIO del tour (23:00 hrs).",
      "Valores no incluyen IVA.",
      "Antes de la salida: n√≥mina de pasajeros (nombre + RUT + fono de emergencia).",
      "Men√∫s de almuerzo se consultan previamente para ahorrar tiempo.",
      "Esta cotizaci√≥n no reserva el minib√∫s completo (pueden existir cupos de terceros). Consulta por arriendo completo."
    ];

    /***** DATA *****/
    const TOURS_FLUVIALES = [
      {
        id: "fluv-1",
        nombre: "Corral‚ÄìMancera (Hist√≥rico)",
        nivel: "Servicio guiado",
        descripcion: "Navegaci√≥n a los castillos espa√±oles de Corral y Mancera. Almuerzo + once a bordo.",
        duracion_horas: 5.6,
        origen: "Valdivia",
        destino: "Castillos de Corral y Mancera",
        precio_adulto: 35000,
        precio_nino: null,
        img: "Fotos/Fuerte-de-CORRAL-Valdivia-1024x679.jpg",
        info: {
          resumen: "Vive una experiencia √∫nica de navegaci√≥n por Los R√≠os de Valdivia rumbo al oc√©ano Pac√≠fico. Este recorrido, de aproximadamente 5 horas, te lleva a conocer la historia y el patrimonio de los emblem√°ticos castillos de San Sebasti√°n de la Cruz de (Corral) y San Pedro de Alc√°ntara (Isla mancera), icono defensivo espa√±ol del sur de Chile. Durante las detenciones podr√°s disfrutar de la reanimaci√≥n hist√≥rica y recorrer ambas localidades y disfrutar sus tradiciones, un tour ideal para quienes buscan cultura, historia y naturaleza en un solo viaje.",
          incluye: [
            "Navegaci√≥n en barco (servicio guiado)",
            "Relato hist√≥rico durante toda la experiencia",
            "Almuerzo a bordo (men√∫ a elecci√≥n)",
            "Once sure√±a a bordo"
          ],
          valores: [
            "1er piso: $30.000",
            "2do piso: $35.000",
            "Ni√±os 5 a 10 a√±os: 20% dcto"
          ],
          notas: [
            "Entradas a Castillo de Corral y Castillo de Mancera: valor adicional (no incluido).",
            "Men√∫ se consulta previamente para agilizar."
          ]
        }
      },
      {
        id: "fluv-2",
        nombre: "Punucapa (Rural y ecol√≥gico)",
        nivel: "Servicio guiado",
        descripcion: "Santuario Carlos Anwandter + Punucapa + degustaciones + feria costumbrista.",
        duracion_horas: 3.5,
        origen: "Valdivia",
        destino: "Punucapa y Santuario",
        precio_adulto: 12000,
        precio_nino: 9600,
        img: "Fotos/punucap.png",
        info: {
          resumen: "* Disfruta de una excursi√≥n de aproximadamente 3 horas y media navegando por el Santuario de la Naturaleza Carlos Anwandter, entre humedales y aves, rumbo a la pintoresca localidad de Punucapa, enclavada a los pies de las monta√±as. * Visitaremos la feria costumbrista local, donde se disfrutan las tradiciones culinarias del lugar. Podr√°s optar por cabalgata de traslado, carreta de bueyes, etc. Cultura, naturaleza e historia con la visita de un patrimonio de la regi√≥n la iglesia de la Virgen de la Candelaria enclavada en un bosque de Cipreses con el ritual del abrazo al Cipr√©s de 400 a√±os y la visita de la f√°brica de sidra de Punucapa, para degustar rica Sidra. * Este destino corresponde a un turismo rural y ecol√≥gico, integrando navegaci√≥n fluvial con una breve caminata en la localidad, ideal para visitar en familia",
          incluye: [
            "Gu√≠a tur√≠stico durante toda la experiencia",
            "Visita a feria costumbrista y f√°brica de sidra",
            "Degustaciones",
            "Suave caminata + visita iglesia Virgen de la Candelaria (seg√∫n operaci√≥n)"
          ],
          valores: [
            "Tarifa general: $12.000",
            "Ni√±os 5 a 10 a√±os: 20% dcto"
          ]
        }
      },
      {
        id: "fluv-3",
        nombre: "Isla Teja / City Tour Valdivia",
        nivel: "Servicio guiado",
        descripcion: "* El tour corto mas completo te ofrece disfrutar de una relajante navegaci√≥n por las tranquilas aguas de 4 de los principales rios de Valdivia y la desembocadura del Santuario de la Naturaleza Carlos Anwandter. Tambi√©n pasaremos por 3 de los puentes que conectan nuestra ciudad como el famoso puente Cau-Cau y el Cruces. * El paisaje de una isla llena de naturaleza y postales te deslumbrar√° como jard√≠n bot√°nico, selva Valdiviana, arquitectura colonial, ruinas del terremoto, etc. * Conocer√°s el verdadero Valdivia desde el r√≠o. * Nuestro barco cuenta con bar para disfrutar de la exquisita cerveza artesanal Valdivia jugos bebidas y snack.",
        duracion_horas: 1,
        origen: "Valdivia",
        destino: "Isla Teja y r√≠os",
        precio_adulto: 5000,
        precio_nino: null,
        img: "Fotos/Valdivia-citytour2.jpg",
        info: {
          resumen: "Recorrido fluvial corto por Valdivia: r√≠os, puentes, entorno del Santuario Carlos Anwandter e Isla Teja.",
          horarios: "Zarpe: cada 1 hora (aprox.)",
          incluye: [
            "Navegaci√≥n por r√≠os y puentes de Valdivia",
            "Recorrido alrededor de Isla Teja",
            "Vista del Santuario Carlos Anwandter (seg√∫n ruta)",
            "Gu√≠a tur√≠stico con relato hist√≥rico",
            "Embarcaci√≥n de alto est√°ndar (seg√∫n operaci√≥n)"
          ],
          valores: [
            "Tarifa general: $5.000",
            "Ni√±os hasta 10 a√±os: GRATIS"
          ],
          notas: ["Bar a bordo (seg√∫n operaci√≥n)."]
        }
      },
      {
        id: "fluv-4",
        nombre: "Humedales y Cisnes (Santuario)",
        nivel: "Servicio guiado",
        descripcion: "* Disfruta de una hermosa navegaci√≥n de aproximadamente 1 hora y media por los humedales del Santuario de la Naturaleza Carlos Anwandter, recorriendo los r√≠os Cruces, Cau-Cau y Valdivia. Una experiencia para apreciar la biodiversidad de la primera ciudad humedal de Chile, rodeado de paisajes √∫nicos de humedales de orilla de rio y fauna silvestre como cisnes de cuello negro, taguas, coipos, etc. * Este tour est√° enfocado a explorar los aspectos ecol√≥gicos y naturales de la ciudad, complementado con un relato hist√≥rico que incluye el terremoto de 1960.",
        duracion_horas: 1.5,
        origen: "Valdivia",
        destino: "Humedales y Santuario",
        precio_adulto: 5000,
        precio_nino: null,
        img: "Fotos/Humedales.jpg",
        info: {
          resumen: "Navegaci√≥n por humedales y r√≠os de Valdivia dentro del Santuario Carlos Anwandter.",
          horarios: "Duraci√≥n: 1 h 30 min (aprox.)",
          incluye: [
            "Recorrido por humedales y r√≠os de Valdivia",
            "Relato hist√≥rico y ecol√≥gico (incluye contexto terremoto 1960)",
            "Gu√≠a tur√≠stico especializado"
          ],
          valores: [
            "Tarifa general: $5.000",
            "Ni√±os hasta 10 a√±os: GRATIS"
          ]
        }
      }
    ];

    const TOURS_TERRESTRES = [
      {
        id: "terr-7",
        nombre: "Termas Geom√©tricas",
        tipo: "Full day termas",
        descripcion: "* Disfruta de una experiencia termal √∫nica, rodeada de bosques nativos, con m√°s de 20 piscinas de aguas termales entre 35¬∞ y 42¬∞C, pasarelas de madera y un entorno ideal para el descanso y la desconexi√≥n.",
        duracion_horas: 13,
        opera_dias: "lunes a domingo",
        precio_adulto: 82000,
        precio_nino: 77000,
        img: "Fotos/Termas%20geometricas.jpeg",
        info: {
          resumen: "Salida full day para vivir Termas Geom√©tricas (entorno natural, piscinas termales y pasarelas).",
          horarios: "Recogida: 07:30‚Äì08:00 h ‚Ä¢ Salida: 08:30 h ‚Ä¢ Regreso: 21:00 h",
          incluye: ["Almuerzo campestre","Navegaci√≥n Lago Calafqu√©n","Minib√∫s (traslados)","Gu√≠a tur√≠stico"],
          valores: ["Adultos: $82.000","Ni√±os: $77.000"]
        }
      },
      {
        id: "terr-2",
        nombre: "Termas Huilo‚ÄìHuilo",
        tipo: "Full day termas",
        descripcion: "* Las Termas Huilo son un verdadero refugio natural, rodeado de bosques nativos y a√∫n poco explorado por el turismo masivo. Este entorno privilegiado permite disfrutar de una experiencia tranquila y casi privada, ideal para el descanso y desconexi√≥n. * El complejo cuenta con piscinas termales con temperatura entre 37 y 40¬∞C, adem√°s de una piscina de agua fr√≠a, barro termal y √°reas naturales a orillas del r√≠o Ra√±intulelfu.",
        duracion_horas: 13,
        opera_dias: "lunes a domingo",
        precio_adulto: 68000,
        precio_nino: 63000,
        img: "Fotos/termas-huilohuilo-2048x1365.jpg",
        info: {
          resumen: "D√≠a completo enfocado en relajo: termas, barro terap√©utico y entorno natural (zona Huilo Huilo).",
          horarios: "Salida: 08:20 h ‚Ä¢ Regreso: 21:00 h",
          incluye: ["Almuerzo campestre","Navegaci√≥n Lago Calafqu√©n","Entrada a termas (3 hrs)","Minib√∫s (traslados)","Gu√≠a tur√≠stico"],
          valores: ["Adultos: $68.000","Ni√±os: $63.000"]
        }
      },
      {
        id: "terr-1",
        nombre: "Reserva Huilo Huilo",
        tipo: "Full day naturaleza",
        descripcion: "* La Reserva Biol√≥gica Huilo Huilo, reconocida como Patrimonio de la Biosfera, es un destino natural √∫nico. Este tour recorre un √°rea de conservaci√≥n con bosques nativos, fauna silvestre, el ic√≥nico Hotel Monta√±a M√°gica y algunas de sus cascadas m√°s emblem√°ticas: Huilo Huilo, La Leona y Llallalca.",
        duracion_horas: 13,
        opera_dias: "lunes a domingo",
        precio_adulto: 58000,
        precio_nino: 53000,
        img: "Fotos/Reserva%20huilohuilo.jpeg",
        info: {
          resumen: "Salida full day para recorrer la Reserva Biol√≥gica Huilo Huilo.",
          horarios: "Salida: 08:00 h ‚Ä¢ Regreso: 21:00 h",
          incluye: ["Almuerzo campestre","Navegaci√≥n Lago Calafqu√©n","Entrada al museo","Minib√∫s (traslados)","Gu√≠a tur√≠stico"],
          valores: ["Adultos: $58.000","Ni√±os: $53.000"]
        }
      },
      {
        id: "terr-6",
        nombre: "Parque Oncol",
        tipo: "Full day cultura y naturaleza",
        descripcion: "* Vive una jornada llena de naturaleza, cultura y paisajes inolvidables. Este tour comienza con la recogida en los alojamientos para recorrer Valdivia, donde nos sumergimos en su arquitectura y rica historia. Posteriormente, disfrutamos de un almuerzo t√≠pico antes de dirigirnos al Parque Oncol, un verdadero refugio de biodiversidad.",
        duracion_horas: 13,
        opera_dias: "lunes a domingo",
        precio_adulto: 40500,
        precio_nino: 37800,
        img: "Fotos/parque%20oncol.jpg",
        info: {
          resumen: "City tour Valdivia + almuerzo t√≠pico + visita al Parque Oncol.",
          horarios: "Salida: 08:00 h ‚Ä¢ Regreso: 21:00 h",
          incluye: ["Almuerzo campestre","Entrada Parque Oncol","Minib√∫s (traslados)","Gu√≠a tur√≠stico"],
          valores: ["Adultos: $40.500","Ni√±os: $37.800"]
        }
      },
      {
        id: "terr-4",
        nombre: "Parque Futangue",
        tipo: "Full day trekking",
        descripcion: "* Descubre uno de los rincones m√°s impresionantes del sur de Chile con este tour al Parque Futangue, a orillas del Lago Ranco. El recorrido permite explorar bosques valdivianos, senderos naturales y paisajes de gran belleza, e incluye una caminata, almuerzo campestre y la visita al Salto Ri√±ihue, finalizando en el encantador pueblo lacustre de Futrono.",
        duracion_horas: 13,
        opera_dias: "lunes a domingo",
        precio_adulto: 63000,
        precio_nino: 58000,
        img: "Fotos/mirador-futangue-1024x484.jpg",
        info: {
          resumen: "Tour al Parque Futangue (Lago Ranco): bosques valdivianos, senderos naturales, paisajes y cierre en Futrono.",
          horarios: "Salida: 07:30‚Äì08:00 h ‚Ä¢ Regreso: 20:20 h (aprox.)",
          incluye: ["Almuerzo (plato principal)","Entrada a portales","Minib√∫s (traslados)","Gu√≠a tur√≠stico"],
          valores: ["Adultos: $63.000","Ni√±os: $58.000"],
          notas: ["En el cat√°logo aparece ‚ÄúRegreso 08:20 h‚Äù, pero corresponde a 20:20 h aprox."]
        }
      },
      {
        id: "terr-3",
        nombre: "City Tour Valdivia‚ÄìNiebla",
        tipo: "City tour cultural",
        descripcion: "* Descubre Valdivia a trav√©s de su arquitectura, historia fluvial y entorno natural. El recorrido incluye una visita a la isla teja y su jard√≠n bot√°nico, uno de los m√°s importantes de Sudam√©rica, para luego continuar hacia Niebla, una hist√≥rica fortificaci√≥n colonial con vistas privilegiadas al oc√©ano Pac√≠fico.",
        duracion_horas: 13,
        opera_dias: "lunes a domingo",
        precio_adulto: 20000,
        precio_nino: 15000,
        img: "Fotos/Tour_terrestre%20citytour.jpg",
        info: {
          resumen: "Recorrido cultural: Valdivia + Jard√≠n Bot√°nico + Niebla y su fortificaci√≥n colonial.",
          horarios: "Salida: 08:00 h ‚Ä¢ Regreso: 21:00 h",
          incluye: ["Almuerzo campestre","Entrada parque Castillo Niebla","Entrada Jard√≠n Bot√°nico","Minib√∫s (traslados)","Gu√≠a tur√≠stico"],
          valores: ["Adultos: $20.000","Ni√±os: $15.000"]
        }
      },
      {
        id: "terr-5",
        nombre: "Parque Alerce Costero",
        tipo: "Full day naturaleza",
        descripcion: "Bosque valdiviano + caminata (detalle a consultar).",
        duracion_horas: 13,
        opera_dias: "lunes a domingo",
        precio_adulto: null,
        precio_nino: null,
        img: "Fotos/parque-alerce-costero.jpg",
        info: {
          resumen: "Detalle en preparaci√≥n (no aparece completo en el cat√°logo adjunto).",
          horarios: "A consultar seg√∫n fecha y operaci√≥n.",
          incluye: [],
          valores: ["Precio: a consultar"]
        }
      }
    ];

    /***** Utils *****/
    const fmtCLP = (n) => {
      if (n === null || n === undefined || n === "") return "";
      try { return "$" + Number(n).toLocaleString("es-CL"); }
      catch { return "$" + n; }
    };

    function showToast(text){
      const t = document.getElementById("toast");
      t.textContent = text;
      t.style.display = "block";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=> t.style.display="none", 3400);
    }

    function normalizePhone(raw){
      const s = String(raw || "").trim();
      if(!s) return "";
      let digits = s.replace(/[^\d+]/g, "");
      digits = digits.replace(/\+/g,"");
      if(digits.startsWith("0")) digits = digits.slice(1);
      if(digits.startsWith("56")) return "+" + digits;
      if(digits.startsWith("9")) return "+56" + digits;
      return "+" + digits;
    }

    function isValidEmail(email){
      const e = String(email || "").trim();
      if(!e) return false;
      return /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(e);
    }

    function escJS(s){
      return String(s || "").replace(/\\/g,"\\\\").replace(/'/g,"\\'");
    }

    function escHTML(s){
      return String(s || "")
        .replace(/&/g,"&amp;")
        .replace(/</g,"&lt;")
        .replace(/>/g,"&gt;")
        .replace(/"/g,"&quot;")
        .replace(/'/g,"&#39;");
    }

    function splitStarBullets(text){
      return String(text || "")
        .split("*")
        .map(p => p.replace(/\s+/g," ").trim())
        .filter(Boolean);
    }

    function formatDescripcionPreview(desc){
      const parts = splitStarBullets(desc);
      if(!parts.length) return "";
      const s = parts[0];
      return s.length > 120 ? (s.slice(0,117) + "‚Ä¶") : s;
    }

    function formatDescripcionFull(desc){
      const parts = splitStarBullets(desc);
      if(!parts.length) return "";
      if(parts.length === 1) return parts[0];
      return "‚Ä¢ " + parts.join("\n‚Ä¢ ");
    }

    function orderedSummary({ tipo, item, nombre, telefono, fecha, personas, ninos, mensaje }){
      const f = fecha ? fecha : "‚Äî";
      const p = (personas !== null && personas !== undefined && personas !== "") ? personas : "‚Äî";
      const k = (ninos !== null && ninos !== undefined && ninos !== "") ? ninos : "‚Äî";
      const m = mensaje ? mensaje : "‚Äî";
      return `${tipo} | ${item} | ${nombre} | ${telefono} | ${f} | Adultos:${p} | Ni√±os:${k} | ${m}`;
    }

    const ALL_TOURS = [...TOURS_FLUVIALES, ...TOURS_TERRESTRES];
    function getTourById(id){ return ALL_TOURS.find(t => t.id === id) || null; }

    function buildInfoText(t, label){
      const lines = [];
      const info = t.info || {};

      const descFull = formatDescripcionFull(t.descripcion);
      if(descFull){
        lines.push("DESCRIPCI√ìN");
        lines.push(descFull);
        lines.push("");
      }

      if(info.resumen) lines.push(info.resumen);

      if(info.horarios){
        lines.push("\nHORARIOS");
        lines.push(info.horarios);
      }

      if(Array.isArray(info.incluye) && info.incluye.length){
        lines.push("\nINCLUYE");
        lines.push("‚Ä¢ " + info.incluye.join("\n‚Ä¢ "));
      }

      if(Array.isArray(info.no_incluye) && info.no_incluye.length){
        lines.push("\nNO INCLUYE");
        lines.push("‚Ä¢ " + info.no_incluye.join("\n‚Ä¢ "));
      }

      const valores = [];
      if(Array.isArray(info.valores) && info.valores.length){
        valores.push(...info.valores);
      }else{
        if(t.precio_adulto) valores.push(`Adulto: ${fmtCLP(t.precio_adulto)}`);
        if(t.precio_nino) valores.push(`Ni√±o: ${fmtCLP(t.precio_nino)}`);
      }
      if(valores.length){
        lines.push("\nVALORES");
        lines.push("‚Ä¢ " + valores.join("\n‚Ä¢ "));
      }

      if(Array.isArray(info.notas) && info.notas.length){
        lines.push("\nNOTAS");
        lines.push("‚Ä¢ " + info.notas.join("\n‚Ä¢ "));
      }

      if(label === "Tour terrestre"){
        lines.push("\nCONDICIONES DE RESERVA");
        lines.push("‚Ä¢ " + CONDICIONES_RESERVA_TERRESTRES.join("\n‚Ä¢ "));
      }

      return lines.join("\n");
    }

    function cardHTML(t, label){
      const meta = [];
      if (t.duracion_horas) meta.push(`‚è±Ô∏è ${t.duracion_horas} h`);
      if (t.origen) meta.push(`üìç ${t.origen}`);
      if (t.destino) meta.push(`üß≠ ${t.destino}`);
      if (t.tipo) meta.push(`üß© ${t.tipo}`);
      if (t.nivel) meta.push(`üß≠ ${t.nivel}`);

      let priceHTML = "";
      const infoVals = (t.info && Array.isArray(t.info.valores)) ? t.info.valores : null;

      if(infoVals && infoVals.length){
        const show = infoVals.slice(0,2).map(v => `<span>${v}</span>`).join("");
        priceHTML = show;
      }else{
        const price = [];
        if (t.precio_adulto) price.push(`Adulto: ${fmtCLP(t.precio_adulto)}`);
        if (t.precio_nino) price.push(`Ni√±o: ${fmtCLP(t.precio_nino)}`);
        priceHTML = price.length
          ? price.map(p => `<span>${p}</span>`).join("")
          : `<span style="color:#5a5564;font-weight:700;">Precio a consultar</span>`;
      }

      const media = t.img
        ? `<div class="card-media media-frame"><img src="${t.img}" alt="${t.nombre}" loading="lazy"></div>`
        : `<div class="card-media media-frame"><div class="media-placeholder"></div></div>`;

      return `
        <div class="card">
          ${media}
          <div class="tag">${label}</div>
          <h3>${t.nombre}</h3>

          <div class="meta">
            ${meta.map(m => `<span class="mini">${m}</span>`).join("")}
          </div>

          <p class="desc">${escHTML(formatDescripcionPreview(t.descripcion) || "‚Äî")}</p>

          <div class="price">${priceHTML}</div>

          <div class="actions">
            <button class="btn btn-primary"
              onclick="openReserve({ tipo:'${escJS(label)}', nombre:'${escJS(t.nombre)}', id:'${escJS(t.id)}' })">Reservar</button>
            <button class="btn btn-ghost"
              onclick="openInfoById('${escJS(t.id)}','${escJS(label)}')">M√°s informaci√≥n</button>
          </div>
        </div>
      `;
    }

    function render(){
      document.getElementById("year").textContent = new Date().getFullYear();
      document.getElementById("grid-fluviales").innerHTML = TOURS_FLUVIALES.map(t => cardHTML(t, "Tour fluvial")).join("");
      document.getElementById("grid-terrestres").innerHTML = TOURS_TERRESTRES.map(t => cardHTML(t, "Tour terrestre")).join("");
    }

    /***** HERO VIDEO *****/
    function initHeroVideo(){
      const v = document.getElementById("heroVideo");
      const playBtn = document.getElementById("heroPlayBtn");
      const soundBtn = document.getElementById("heroSoundBtn");
      if(!v) return;

      v.src = HERO_VIDEO_URL;
      v.muted = true;

      playBtn.addEventListener("click", () => openVideo());

      soundBtn.addEventListener("click", () => {
        v.muted = !v.muted;
        soundBtn.textContent = v.muted ? "üîá Silencio" : "üîä Sonido";
      });

      v.addEventListener("play", () => {
        playBtn.style.display = "none";
        soundBtn.style.display = "inline-flex";
        soundBtn.textContent = v.muted ? "üîá Silencio" : "üîä Sonido";
      });

      v.addEventListener("pause", () => {
        playBtn.style.display = "inline-flex";
        soundBtn.style.display = "none";
      });

      v.addEventListener("error", () => {
        playBtn.style.display = "none";
        soundBtn.style.display = "none";
        showToast("No se encontr√≥ el video. Revisa la ruta: " + HERO_VIDEO_URL);
      });
    }

    function openVideo(){
      const b = document.getElementById("videoBackdrop");
      const big = document.getElementById("bigVideo");
      const hero = document.getElementById("heroVideo");
      try{ hero && hero.pause(); }catch{}
      big.src = HERO_VIDEO_URL;
      big.currentTime = 0;
      big.muted = false;
      b.style.display = "flex";
      b.setAttribute("aria-hidden","false");
      lockScroll();
      big.play().catch(()=>{});
    }

    function closeVideo(){
      const b = document.getElementById("videoBackdrop");
      const big = document.getElementById("bigVideo");
      if(b.style.display === "flex") unlockScroll();
      try{ big.pause(); }catch{}
      big.src = "";
      b.style.display = "none";
      b.setAttribute("aria-hidden","true");
    }

    /***** Drawer *****/
    function openDrawer(){
      const b = document.getElementById("drawerBackdrop");
      b.style.display = "block";
      b.setAttribute("aria-hidden","false");
      lockScroll();
    }
    function closeDrawer(){
      const b = document.getElementById("drawerBackdrop");
      if(b.style.display === "block") unlockScroll();
      b.style.display = "none";
      b.setAttribute("aria-hidden","true");
    }

    /***** Reserva modal *****/
    let selected = null;

    function openReserve(payload){
      selected = payload;

      // ‚úÖ META: InitiateCheckout (abrir modal reserva)
      const t = payload?.id ? getTourById(payload.id) : null;
      const value = getNumericValueFromTour(t);

      const icParams = {
        content_name: payload?.nombre || "Reserva",
        content_ids: payload?.id ? [payload.id] : [],
        content_type: "product",
        content_category: payload?.tipo || "Solicitud"
      };
      if(value) { icParams.value = value; icParams.currency = META_CURRENCY; }
      trackMeta("InitiateCheckout", icParams);

      const b = document.getElementById("reserveBackdrop");
      const meta = document.getElementById("reserveMeta");
      const note = document.getElementById("reserveNote");

      meta.innerHTML = `
        <span class="chip">üìå ${payload.tipo || "Solicitud"}</span>
        <span class="chip">üó∫Ô∏è ${payload.nombre || "‚Äî"}</span>
      `;

      document.getElementById("r_nombre").value = "";
      document.getElementById("r_email").value = "";
      document.getElementById("r_tel").value = "";
      document.getElementById("r_personas").value = "";
      document.getElementById("r_ninos").value = "";
      document.getElementById("r_fecha").value = "";
      document.getElementById("r_msg").value = "";

      // ‚úÖ reset alojamiento fields
      document.getElementById("s_checkin").value = "";
      document.getElementById("s_checkout").value = "";
      document.getElementById("s_adultos").value = "";
      document.getElementById("s_ninos").value = "0";
      document.getElementById("s_zona").value = "";
      document.getElementById("s_tipo").value = "";
      document.getElementById("s_presupuesto").value = "";
      document.getElementById("s_mascotas").value = "";

      // ‚úÖ mostrar/ocultar seg√∫n tipo
      const tipo = payload?.tipo || "Solicitud";
      const isStay = (tipo === "Alojamiento");
      document.getElementById("tourFieldsRow").style.display = isStay ? "none" : "grid";
      document.getElementById("stayFields").style.display = isStay ? "block" : "none";

      // ‚úÖ min dates
      const min = minDateForTipo(tipo);
      const fechaEl = document.getElementById("r_fecha");
      fechaEl.min = min;

      // ‚úÖ default ni√±os en tours
      if(tipo === "Tour fluvial" || tipo === "Tour terrestre"){
        document.getElementById("r_ninos").value = "0";
      }

      // ‚úÖ min alojamiento (ma√±ana)
      const minStay = chileDateYMDPlus(1);
      const inEl = document.getElementById("s_checkin");
      const outEl = document.getElementById("s_checkout");
      inEl.min = minStay;
      outEl.min = minStay;

      note.textContent = WEBHOOK_URL
        note.dataset.baseText = note.textContent;
        ? "‚úÖ Se enviar√° tu solicitud al sistema. Luego te contactamos por WhatsApp."
        : "‚ö†Ô∏è Falta configurar WEBHOOK_URL en el c√≥digo.";

      b.style.display = "flex";
      b.setAttribute("aria-hidden","false");
      lockScroll();
      resetModalScroll("reserveBackdrop");

      // ‚úÖ aplica bloqueo (si ya envi√≥: esconde todo)
      const locked = applyReserveLockState();
      if(!locked) setTimeout(() => document.getElementById("r_nombre").focus(), 60);
    }

    function closeReserve(){
      const b = document.getElementById("reserveBackdrop");
      if(b.style.display === "flex") unlockScroll();
      b.style.display = "none";
      b.setAttribute("aria-hidden","true");
      selected = null;
    }

    function buildPricePayload(tipo, tour){
      const moneda = "CLP";
      if(tipo === "Alojamiento"){
        return { moneda, precio_adulto: null, precio_nino: null, precio_display: "A consultar" };
      }
      const pa = (tour && tour.precio_adulto != null) ? tour.precio_adulto : null;
      const pn = (tour && tour.precio_nino != null) ? tour.precio_nino : null;
      const parts = [];
      if(pa) parts.push(`Adulto: ${fmtCLP(pa)}`);
      if(pn) parts.push(`Ni√±o: ${fmtCLP(pn)}`);
      const precio_display = parts.length ? parts.join(" | ") : "Precio a consultar";
      return { moneda, precio_adulto: pa, precio_nino: pn, precio_display };
    }

    let __sendingReserve = false;

    async function submitReserve(){
      if(__sendingReserve) return;

      if(isReserveRateLimited()){
        applyReserveLockState();
        showToast("Ya enviaste una solicitud desde este dispositivo.");
        return;
      }

      const btn = document.getElementById("reserveSendBtn");

      const nombre = (document.getElementById("r_nombre").value || "").trim();
      const emailRaw = (document.getElementById("r_email").value || "").trim();
      const telRaw = (document.getElementById("r_tel").value || "").trim();
      const telefono = normalizePhone(telRaw);
      const mensaje = (document.getElementById("r_msg").value || "").trim();

      if(!nombre || !telefono){ showToast("Falta nombre o tel√©fono."); return; }
      if(emailRaw && !isValidEmail(emailRaw)){ showToast("Correo inv√°lido."); return; }
      if(!WEBHOOK_URL){ showToast("Falta configurar WEBHOOK_URL."); return; }

      const tipo = selected?.tipo || "Solicitud";
      const item = selected?.nombre || "Consulta";

      const isStay = (tipo === "Alojamiento");

      // ‚úÖ Tour fields
      const personasRaw = (document.getElementById("r_personas").value || "").trim();
      const fechaRaw = (document.getElementById("r_fecha").value || "").trim();
      const ninosRaw = (document.getElementById("r_ninos").value || "").trim();

      let personas = null;
      if(personasRaw !== ""){
        const p = Number(personasRaw);
        if(!Number.isFinite(p) || p < 0){ showToast("N¬∞ personas inv√°lido."); return; }
        personas = p;
      }

      let ninos = null;
      if(ninosRaw !== ""){
        const k = Number(ninosRaw);
        if(!Number.isFinite(k) || k < 0){ showToast("N¬∞ ni√±os inv√°lido."); return; }
        ninos = k;
      }
      if(tipo === "Tour fluvial" || tipo === "Tour terrestre"){
        if(ninos === null) ninos = 0; // ‚úÖ default 0
      }

      // ‚úÖ Alojamiento fields
      const checkin = (document.getElementById("s_checkin").value || "").trim();
      const checkout = (document.getElementById("s_checkout").value || "").trim();
      const sAdultosRaw = (document.getElementById("s_adultos").value || "").trim();
      const sNinosRaw = (document.getElementById("s_ninos").value || "").trim();
      const sZona = (document.getElementById("s_zona").value || "").trim();
      const sTipo = (document.getElementById("s_tipo").value || "").trim();
      const sPres = (document.getElementById("s_presupuesto").value || "").trim();
      const sMasc = (document.getElementById("s_mascotas").value || "").trim();

      let stayAdultos = null;
      if(sAdultosRaw !== ""){
        const a = Number(sAdultosRaw);
        if(!Number.isFinite(a) || a < 0){ showToast("N¬∞ adultos inv√°lido."); return; }
        stayAdultos = a;
      }

      let stayNinos = null;
      if(sNinosRaw !== ""){
        const k2 = Number(sNinosRaw);
        if(!Number.isFinite(k2) || k2 < 0){ showToast("N¬∞ ni√±os inv√°lido."); return; }
        stayNinos = k2;
      }

      // ‚úÖ validar fechas m√≠nimas
      if(!isStay){
        const min = minDateForTipo(tipo);
        if(fechaRaw && fechaRaw < min){
          showToast("Fecha inv√°lida. Elige desde " + min + ".");
          return;
        }
      }else{
        const minStay = chileDateYMDPlus(1);
        if(checkin && checkin < minStay){
          showToast("Check-in inv√°lido. Elige desde " + minStay + ".");
          return;
        }
        if(checkout){
          const minOut = checkin ? checkin : minStay;
          if(checkout < minOut){
            showToast("Check-out inv√°lido. Revisa las fechas.");
            return;
          }
          if(checkin && checkout <= checkin){
            showToast("El check-out debe ser despu√©s del check-in.");
            return;
          }
        }
      }

      const t = selected?.id ? getTourById(selected.id) : null;
      const pricePack = buildPricePayload(tipo, t);

      // ‚úÖ fecha est√°ndar: en tours usa fecha tentativa; en alojamiento usa check-in
      const fecha = isStay ? (checkin || null) : (fechaRaw || null);

      const payload = {
        submission_id: submissionId(),
        event: "request",
        source: "vacacionesenelsur_web",
        form: "reserva",
        created_at: nowChileISO(),
        timezone: "America/Santiago",
        tipo,
        item,
        item_id: selected?.id || null,
        ...pricePack,
        nombre,
        telefono,
        email: emailRaw || null,
        fecha: fecha,
        personas: isStay ? (stayAdultos != null ? stayAdultos : null) : (personas != null ? personas : null),
        ninos: isStay ? (stayNinos != null ? stayNinos : null) : (ninos != null ? ninos : null),
        mensaje: mensaje || null
      };

      if(isStay){
        payload.alojamiento = {
          checkin: checkin || null,
          checkout: checkout || null,
          adultos: stayAdultos != null ? stayAdultos : null,
          ninos: stayNinos != null ? stayNinos : null,
          zona: sZona || null,
          tipo: sTipo || null,
          presupuesto: sPres || null,
          mascotas: sMasc || null
        };
        payload.resumen_ordenado =
          `Alojamiento | ${nombre} | ${telefono} | ${checkin || "‚Äî"} | ${checkout || "‚Äî"} | Adultos:${(stayAdultos!=null?stayAdultos:"‚Äî")} | Ni√±os:${(stayNinos!=null?stayNinos:"‚Äî")} | Zona:${sZona||"‚Äî"} | Tipo:${sTipo||"‚Äî"} | Presupuesto:${sPres||"‚Äî"} | Mascotas:${sMasc||"‚Äî"} | ${mensaje || "‚Äî"}`;
      }else{
        payload.resumen_ordenado = orderedSummary({ tipo, item, nombre, telefono, fecha, personas, ninos, mensaje });
      }

      __sendingReserve = true;
      const prevText = btn ? btn.textContent : "";
      if(btn){ btn.disabled = true; btn.textContent = "Enviando‚Ä¶"; }

      try{
        await postJSON(WEBHOOK_URL, payload, 12000);

        // ‚úÖ META: Lead (solo cuando envi√≥ OK)
        const value = getNumericValueFromTour(t);
        const leadParams = {
          lead_type: "reserva",
          form: "reserva",
          content_name: item,
          content_ids: selected?.id ? [selected.id] : [],
          content_category: tipo
        };
        if(value) { leadParams.value = value; leadParams.currency = META_CURRENCY; }
        trackMeta("Lead", leadParams);

        // ‚úÖ bloquea para que no vuelva a enviar
        writeLock(LOCK_KEYS.reserva, { submission_id: payload.submission_id });
applyReserveLockState();


        closeReserve();
        showToast("Listo ‚úÖ Te escribiremos por WhatsApp para coordinar horarios y pagos.");
      }catch(e){
        console.warn(e);
        showToast("No se pudo enviar. Intenta otra vez.");
        if(btn && !isReserveRateLimited()){ btn.disabled = false; btn.textContent = prevText || "Enviar solicitud"; }
      }finally{
        __sendingReserve = false;
      }
    }

    /***** Info modal *****/
    let infoSelected = null;

    function openInfoById(id, label){
      const t = getTourById(id);
      if(!t){ showToast("No se encontr√≥ el tour."); return; }
      infoSelected = { ...t, label };

      // ‚úÖ META: ViewContent (ver detalle tour)
      const value = getNumericValueFromTour(t);
      const vcParams = {
        content_name: t.nombre,
        content_ids: [t.id],
        content_type: "product",
        content_category: label
      };
      if(value) { vcParams.value = value; vcParams.currency = META_CURRENCY; }
      trackMeta("ViewContent", vcParams);

      const b = document.getElementById("infoBackdrop");
      document.getElementById("infoTitle").textContent = t.nombre;
      document.getElementById("infoSubtitle").textContent = label;

      const meta = [];
      if (t.duracion_horas) meta.push(`‚è±Ô∏è ${t.duracion_horas} h`);
      if (t.origen) meta.push(`üìç ${t.origen}`);
      if (t.destino) meta.push(`üß≠ ${t.destino}`);
      if (t.tipo) meta.push(`üß© ${t.tipo}`);
      if (t.nivel) meta.push(`üß≠ ${t.nivel}`);

      if(t.info && t.info.horarios){
        const short = String(t.info.horarios).split("‚Ä¢").slice(0,2).join("‚Ä¢").trim();
        meta.push(`üïí ${short}`);
      }

      if(t.info && Array.isArray(t.info.valores) && t.info.valores.length){
        const v = t.info.valores[0];
        if(v && v.length < 28) meta.push(`üí≥ ${v}`);
      }else{
        if(t.precio_adulto) meta.push(`Adulto: ${fmtCLP(t.precio_adulto)}`);
        if(t.precio_nino) meta.push(`Ni√±o: ${fmtCLP(t.precio_nino)}`);
      }

      document.getElementById("infoMeta").innerHTML = meta.map(x => `<span class="chip">${x}</span>`).join("");
      document.getElementById("infoBody").textContent = buildInfoText(t, label);

      b.style.display = "flex";
      b.setAttribute("aria-hidden","false");
      lockScroll();
      resetModalScroll("infoBackdrop");
    }

    function closeInfo(){
      const b = document.getElementById("infoBackdrop");
      if(b.style.display === "flex") unlockScroll();
      b.style.display = "none";
      b.setAttribute("aria-hidden","true");
      infoSelected = null;
    }

    function infoReserve(){
      if(!infoSelected) return;
      closeInfo();
      openReserve({ tipo: infoSelected.label, nombre: infoSelected.nombre, id: infoSelected.id });
    }

    /***** Meeting modal *****/
    function openMeeting(){
      const b = document.getElementById("meetBackdrop");
      document.getElementById("m_tipo").value = "";
      document.getElementById("m_nombre").value = "";
      document.getElementById("m_email").value = "";
      document.getElementById("m_tel").value = "";
      document.getElementById("m_tema").value = "";

      document.getElementById("meetNote").textContent = WEBHOOK_URL
        ? "‚úÖ Se enviar√° tu solicitud. Te contactamos por WhatsApp para coordinar."
        : "‚ö†Ô∏è Falta configurar WEBHOOK_URL en el c√≥digo.";

      b.style.display = "flex";
      b.setAttribute("aria-hidden","false");
      lockScroll();
      resetModalScroll("meetBackdrop");

      // ‚úÖ aplica bloqueo (si ya envi√≥: esconde todo)
      const locked = applyMeetLockState();
      if(!locked) setTimeout(() => document.getElementById("m_tipo").focus(), 60);
    }

    function closeMeeting(){
      const b = document.getElementById("meetBackdrop");
      if(b.style.display === "flex") unlockScroll();
      b.style.display = "none";
      b.setAttribute("aria-hidden","true");
    }

    let __sendingMeeting = false;

    async function submitMeeting(){
      if(__sendingMeeting) return;

      if(isLocked(LOCK_KEYS.reunion)){
        applyMeetLockState();
        showToast("Ya enviaste una solicitud de reuni√≥n desde este dispositivo.");
        return;
      }

      const btn = document.getElementById("meetSendBtn");

      const grupo_tipo = (document.getElementById("m_tipo").value || "").trim();
      const nombre = (document.getElementById("m_nombre").value || "").trim();
      const emailRaw = (document.getElementById("m_email").value || "").trim();
      const telRaw = (document.getElementById("m_tel").value || "").trim();
      const telefono = normalizePhone(telRaw);
      const tema = (document.getElementById("m_tema").value || "").trim();

      if(!grupo_tipo){ showToast("Selecciona si es colegio/universidad/evento/empresa."); return; }
      if(!nombre || !telefono){ showToast("Falta nombre o tel√©fono."); return; }
      if(!emailRaw){ showToast("Falta correo."); return; }
      if(!isValidEmail(emailRaw)){ showToast("Correo inv√°lido."); return; }
      if(!WEBHOOK_URL){ showToast("Falta configurar WEBHOOK_URL."); return; }

      const payload = {
        submission_id: submissionId(),
        event: "meeting_request",
        source: "vacacionesenelsur_web",
        form: "reunion",
        created_at: nowChileISO(),
        timezone: "America/Santiago",
        grupo_tipo,
        nombre,
        telefono,
        email: emailRaw,
        tema: tema || null,
        resumen_ordenado: `${grupo_tipo} | ${nombre} | ${telefono} | ${emailRaw} | ${tema || "‚Äî"}`
      };

      __sendingMeeting = true;
      const prevText = btn ? btn.textContent : "";
      if(btn){ btn.disabled = true; btn.textContent = "Enviando‚Ä¶"; }

      try{
        await postJSON(WEBHOOK_URL, payload, 12000);

        // ‚úÖ META: Lead (reuni√≥n)
        trackMeta("Lead", {
          lead_type: "reunion",
          form: "reunion",
          content_category: grupo_tipo
        });

        // ‚úÖ bloquea para que no vuelva a enviar
        writeLock(LOCK_KEYS.reunion, { submission_id: payload.submission_id });
        applyMeetLockState();

        closeMeeting();
        showToast("Solicitud enviada ‚úÖ Te contactamos por WhatsApp.");
      }catch(e){
        console.warn(e);
        showToast("No se pudo enviar. Intenta otra vez.");
        if(btn && !isLocked(LOCK_KEYS.reunion)){ btn.disabled = false; btn.textContent = prevText || "Enviar"; }
      }finally{
        __sendingMeeting = false;
      }
    }

    /***** Alliance submit *****/
    function clearAlliance(){
      if(isLocked(LOCK_KEYS.alianza)){
        applyAllianceLockState();
        showToast("Este formulario ya fue enviado desde este dispositivo.");
        return;
      }

      ["a_nombre","a_email","a_tel","a_localidad","a_marca","a_rubro","a_msg"].forEach(id => {
        const el = document.getElementById(id);
        if(el) el.value = "";
      });
      document.getElementById("allyNote").textContent = "";
      showToast("Listo. Formulario limpio.");
    }

    let __sendingAlliance = false;

    async function submitAlliance(){
      if(__sendingAlliance) return;

      if(isLocked(LOCK_KEYS.alianza)){
        applyAllianceLockState();
        showToast("Ya enviaste este formulario desde este dispositivo.");
        return;
      }

      const sendBtn = document.getElementById("allySendBtn");

      const nombre = (document.getElementById("a_nombre").value || "").trim();
      const email = (document.getElementById("a_email").value || "").trim();
      const telRaw = (document.getElementById("a_tel").value || "").trim();
      const telefono = normalizePhone(telRaw);
      const localidad = (document.getElementById("a_localidad").value || "").trim();
      const marca = (document.getElementById("a_marca").value || "").trim();
      const rubro = (document.getElementById("a_rubro").value || "").trim();
      const mensaje = (document.getElementById("a_msg").value || "").trim();

      if(!nombre || !email || !telefono || !marca){ showToast("Falta nombre, correo, tel√©fono o marca."); return; }
      if(!isValidEmail(email)){ showToast("Correo inv√°lido."); return; }
      if(!WEBHOOK_URL){ showToast("Falta configurar WEBHOOK_URL."); return; }

      const payload = {
        submission_id: submissionId(),
        event: "alliance_lead",
        source: "vacacionesenelsur_web",
        form: "alianza",
        created_at: nowChileISO(),
        timezone: "America/Santiago",
        nombre,
        email,
        telefono,
        localidad: localidad || null,
        marca,
        rubro: rubro || null,
        mensaje: mensaje || null,
        resumen_ordenado: `Alianza | ${marca} | ${nombre} | ${telefono} | ${email} | ${rubro || "‚Äî"} | ${localidad || "‚Äî"}`
      };

      const note = document.getElementById("allyNote");
      note.textContent = "Enviando‚Ä¶";

      __sendingAlliance = true;
      const prevText = sendBtn ? sendBtn.textContent : "";
      if(sendBtn){ sendBtn.disabled = true; sendBtn.textContent = "Enviando‚Ä¶"; }

      try{
        await postJSON(WEBHOOK_URL, payload, 12000);

        // ‚úÖ META: Lead (alianza)
        trackMeta("Lead", {
          lead_type: "alianza",
          form: "alianza",
          content_name: marca,
          content_category: rubro || "Alianza"
        });

        // ‚úÖ bloquea para que no vuelva a enviar + oculta campos
        writeLock(LOCK_KEYS.alianza, { submission_id: payload.submission_id });
        applyAllianceLockState();

        note.textContent = `‚úÖ Recibido. Te contactamos para coordinar la alianza.`;
        showToast("Alianza enviada ‚úÖ");
      }catch(e){
        console.warn(e);
        note.textContent = "‚ö†Ô∏è No se pudo enviar. Intenta otra vez.";
        showToast("No se pudo enviar.");
        if(sendBtn && !isLocked(LOCK_KEYS.alianza)){ sendBtn.disabled = false; sendBtn.textContent = prevText || "Enviar"; }
      }finally{
        __sendingAlliance = false;
      }
    }

    // Click outside + ESC
    document.addEventListener("click", (e) => {
      const r = document.getElementById("reserveBackdrop");
      const i = document.getElementById("infoBackdrop");
      const m = document.getElementById("meetBackdrop");
      const d = document.getElementById("drawerBackdrop");
      const v = document.getElementById("videoBackdrop");

      if (r.style.display==="flex" && e.target===r) closeReserve();
      if (i.style.display==="flex" && e.target===i) closeInfo();
      if (m.style.display==="flex" && e.target===m) closeMeeting();
      if (d.style.display==="block" && e.target===d) closeDrawer();
      if (v.style.display==="flex" && e.target===v) closeVideo();
    });

    document.addEventListener("keydown", (e) => {
      if(e.key==="Escape"){
        closeReserve(); closeInfo(); closeMeeting(); closeDrawer(); closeVideo();
      }
    });

    document.getElementById("menuBtn").addEventListener("click", openDrawer);
    document.getElementById("drawerClose").addEventListener("click", closeDrawer);
    document.querySelectorAll("[data-drawer-link]").forEach(a => a.addEventListener("click", closeDrawer));

    // ‚úÖ Ajuste din√°mico checkout min seg√∫n checkin (solo alojamiento)
    document.getElementById("s_checkin").addEventListener("change", () => {
      const inEl = document.getElementById("s_checkin");
      const outEl = document.getElementById("s_checkout");
      const minBase = chileDateYMDPlus(1);
      const v = (inEl.value || "").trim();
      outEl.min = v ? v : minBase;
      if(outEl.value && outEl.value < outEl.min) outEl.value = "";
    });

    render();
    initHeroVideo();

    // ‚úÖ aplica bloqueo al cargar (importante para Alianza que est√° visible)
    applyAllianceLockState();
  </script>
</body>
</html>
